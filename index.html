<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Psychology Assessment | AI-Enhanced Insights</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7ZVV3LY8MS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7ZVV3LY8MS');
    </script>
    
    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "rt0249zmhv");
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .ai-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .content {
            padding: 40px;
        }

        .intro {
            text-align: center;
            margin-bottom: 40px;
        }

        .intro h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .intro p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .social-proof {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .proof-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .proof-icon {
            font-size: 1.2rem;
        }

        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            font-weight: 600;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .question-container {
            display: none;
            text-align: center;
        }

        .question-container.active {
            display: block;
        }

        .question {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .answers {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .answer {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .answer:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .answer.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-container {
            display: none;
            text-align: center;
        }

        .results-container.active {
            display: block;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
        }

        .ai-insights {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .ai-insights h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .risk-alerts {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .risk-alerts.high {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .personalized-tips {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .pattern-detected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .email-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .email-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .email-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .email-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .email-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .disclaimer {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            margin-top: 20px;
            line-height: 1.4;
        }

        .premium-cta-section {
            margin-top: 30px;
            text-align: center;
        }

        .premium-cta {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            color: white;
        }

        .premium-cta h3 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .premium-cta p {
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .premium-button {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .premium-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .premium-benefits {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .waitlist-info {
            margin-top: 15px;
            opacity: 0.8;
        }

        .waitlist-info small {
            font-size: 0.85rem;
        }

        .results-disclaimer {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.85rem;
            color: #666;
            line-height: 1.5;
        }

        .results-disclaimer strong {
            color: #333;
        }

        .benefit {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .sharing-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        .sharing-section h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .sharing-section p {
            color: #666;
            margin-bottom: 20px;
        }

        .qr-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        #qr-code {
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        .share-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .share-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .share-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .loading {
            display: none;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
        }

        .admin-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .admin-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }

        .admin-mode .admin-toggle {
            display: block;
        }

        .admin-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 3px;
            width: 100%;
        }

        .admin-stats {
            font-size: 12px;
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .content { padding: 20px; }
            .email-form { flex-direction: column; }
            .email-input { margin-bottom: 10px; }
            .admin-panel { right: 5px; top: 5px; }
            .admin-toggle { right: 5px; top: 5px; }
            
            .social-proof {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .premium-benefits {
                flex-direction: column;
                gap: 10px;
            }
            
            .qr-container {
                flex-direction: column;
            }
            
            .share-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Admin Panel -->
    <button class="admin-toggle" onclick="toggleAdminPanel()">üìä Admin</button>
    <div class="admin-panel" id="admin-panel">
        <div class="admin-stats" id="admin-stats">Loading...</div>
        <button class="admin-button" onclick="exportToCSV()">üì• Export CSV</button>
        <button class="admin-button" onclick="exportToJSON()">üìÑ Export JSON</button>
        <button class="admin-button" onclick="showWaitlistEmails()">üìß Waitlist Emails</button>
        <button class="admin-button" onclick="exportWaitlist()">üì• Export Waitlist</button>
        <button class="admin-button" onclick="showDetailedInsights()">üìä Insights</button>
        <button class="admin-button" onclick="showAIPatterns()">üß† AI Patterns</button>
        <button class="admin-button" onclick="backupData()">üíæ Backup</button>
        <button class="admin-button" onclick="clearAllData()">üóëÔ∏è Clear All</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Trading Psychology Assessment</h1>
            <p>AI-Enhanced Emotional Pattern Recognition</p>
            <div class="ai-badge">üß† Dynamic Insights Generator</div>
        </div>

        <div class="content">
            <div class="intro" id="intro">
                <h2>Master Your Trading Psychology with AI</h2>
                <p>Our advanced assessment uses artificial intelligence to identify your unique emotional trading patterns, detect risk behaviors, and generate personalized improvement strategies.</p>
                
                <!-- Social Proof Section -->
                <div class="social-proof">
                    <div class="proof-item">
                        <span class="proof-icon">üß†</span>
                        <span class="proof-text">AI-Powered Pattern Recognition</span>
                    </div>
                    <div class="proof-item">
                        <span class="proof-icon">‚ö°</span>
                        <span class="proof-text">Instant Personalized Insights</span>
                    </div>
                    <div class="proof-item">
                        <span class="proof-icon">üìä</span>
                        <span class="proof-text">Advanced Risk Assessment</span>
                    </div>
                </div>
                
                <button class="start-button" onclick="startAssessment()">Start AI Assessment Now</button>
                
                <div class="disclaimer">
                    Educational analysis of emotional trading patterns - not financial advice. 
                    For investment decisions, consult a licensed financial advisor. 
                    By using this tool, you consent to analytics cookies for website improvement.
                </div>
            </div>

            <div class="question-container" id="question-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                
                <div class="question" id="question-text"></div>
                <div class="answers" id="answers"></div>
            </div>

            <div class="results-container" id="results-container">
                <h2>Your AI-Enhanced Trading Psychology Results</h2>
                <div class="score-circle" id="score-circle">0</div>
                <div id="results-content"></div>
                <div id="ai-insights-container"></div>
                
                <div class="email-section">
                    <h3>Get Your Complete AI Analysis Report</h3>
                    <p>Receive your personalized PDF with advanced AI insights, risk patterns, and custom improvement strategies.</p>
                    <div class="email-form">
                        <input type="email" class="email-input" id="email-input" placeholder="Enter your email address" required>
                        <button class="email-button" onclick="submitEmail()">Get AI Report</button>
                    </div>
                    <div class="loading" id="loading">‚è≥ Generating your AI-enhanced report...</div>
                    <div class="disclaimer">
                        You'll receive an AI-personalized report with advanced insights. Unsubscribe anytime.
                    </div>
                </div>

                <!-- Premium Toolkit CTA Section -->
                <div class="premium-cta-section">
                    <div class="premium-cta">
                        <h3>üöÄ Coming Soon: Advanced AI Psychology Toolkit</h3>
                        <p>Be the first to know when our comprehensive AI-enhanced toolkit launches. Get advanced pattern recognition, daily progress tracking, and personalized training plans.</p>
                        <button class="premium-button" onclick="joinWaitlist()">üîî Get Notified When Available</button>
                        <div class="premium-benefits">
                            <div class="benefit">üß† Advanced AI Analysis</div>
                            <div class="benefit">üìä Daily Progress Tracking</div>
                            <div class="benefit">üìà Personalized Training Plans</div>
                        </div>
                        <div class="waitlist-info">
                            <small>‚ú® Waitlist members get exclusive early access + special pricing</small>
                        </div>
                    </div>
                </div>

                <!-- QR Code Sharing Section -->
                <div class="sharing-section">
                    <h3>üì± Share This AI Assessment</h3>
                    <p>Help other traders discover their psychological patterns</p>
                    <div class="qr-container">
                        <canvas id="qr-code" width="120" height="120"></canvas>
                        <div class="share-buttons">
                            <button class="share-button" onclick="copyAssessmentLink()">üìã Copy Link</button>
                            <button class="share-button" onclick="downloadQRCode()">üì± Download QR Code</button>
                        </div>
                    </div>
                </div>

                <!-- Results Disclaimer -->
                <div class="results-disclaimer">
                    <p><strong>Important Disclaimer:</strong> This AI-enhanced assessment provides educational analysis of emotional trading patterns and is not financial advice. Results are based on self-reported responses and pattern recognition algorithms. For investment decisions and professional trading psychology support, consult a licensed financial advisor or qualified trading psychology specialist. Past performance and psychological assessments do not guarantee future trading results.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        window.adminPanelOpen = false;

        // ===== AI DYNAMIC INSIGHTS GENERATOR =====
        
        class AIInsightsEngine {
            constructor() {
                this.patterns = new Map();
                this.riskFactors = new Map();
                this.recommendations = new Map();
                this.initializeAIKnowledge();
            }

            initializeAIKnowledge() {
                // FOMO Pattern Detection
                this.patterns.set('fomo_high', {
                    triggers: [0, 4], // Questions about missing out and other traders
                    threshold: 6,
                    description: 'High FOMO susceptibility detected',
                    risk: 'high'
                });

                this.patterns.set('revenge_trading', {
                    triggers: [0, 3], // Questions about losses and consecutive losses
                    threshold: 4,
                    description: 'Revenge trading pattern identified',
                    risk: 'high'
                });

                this.patterns.set('analysis_paralysis', {
                    triggers: [6, 7], // Preparation and stress questions
                    threshold: 5,
                    description: 'Over-analysis tendency detected',
                    risk: 'medium'
                });

                this.patterns.set('impulsive_behavior', {
                    triggers: [7], // Stress response
                    threshold: 2,
                    description: 'Impulsive decision-making pattern',
                    risk: 'high'
                });

                this.patterns.set('risk_inconsistency', {
                    triggers: [5], // Risk management
                    threshold: 3,
                    description: 'Inconsistent risk management approach',
                    risk: 'medium'
                });

                // Advanced categorization beyond basic 4
                this.setupAdvancedCategories();
                this.setupDynamicRecommendations();
            }

            setupAdvancedCategories() {
                this.advancedCategories = {
                    'fomo_trader': {
                        name: 'FOMO-Driven Trader',
                        description: 'Primarily motivated by fear of missing out',
                        color: '#ff6b6b'
                    },
                    'revenge_trader': {
                        name: 'Revenge Trader',
                        description: 'Tends to chase losses with larger positions',
                        color: '#ee5a24'
                    },
                    'analysis_paralysis_trader': {
                        name: 'Analysis Paralysis Trader',
                        description: 'Over-analyzes and struggles with execution',
                        color: '#feca57'
                    },
                    'emotional_swing_trader': {
                        name: 'Emotional Swing Trader',
                        description: 'High emotional volatility in trading decisions',
                        color: '#ff9ff3'
                    },
                    'disciplined_but_stressed': {
                        name: 'Disciplined but Stressed',
                        description: 'Good rules but struggles under pressure',
                        color: '#54a0ff'
                    }
                };
            }

            setupDynamicRecommendations() {
                this.recommendations.set('fomo_high', [
                    'Implement a "cooling-off" period before entering trades seen on social media',
                    'Create a predefined trading plan and stick to it regardless of market noise',
                    'Set daily screen time limits for trading-related social media',
                    'Practice mindfulness exercises before trading sessions'
                ]);

                this.recommendations.set('revenge_trading', [
                    'Implement automatic position sizing that cannot be overridden',
                    'Take a mandatory 24-hour break after any loss exceeding 2%',
                    'Use stop-losses that are automatically executed',
                    'Journal emotional state before each trade'
                ]);

                this.recommendations.set('analysis_paralysis', [
                    'Set a maximum time limit for trade analysis (e.g., 15 minutes)',
                    'Use decision-making frameworks with clear criteria',
                    'Practice taking smaller positions to reduce decision pressure',
                    'Implement "good enough" decision rules'
                ]);

                this.recommendations.set('impulsive_behavior', [
                    'Implement a 10-minute rule before executing any trade',
                    'Use limit orders instead of market orders',
                    'Practice breathing exercises during stressful market moments',
                    'Create a pre-trade checklist that must be completed'
                ]);
            }

            analyzePatterns(answers) {
                var detectedPatterns = [];
                var riskLevel = this.calculateRiskLevel(answers);
                
                // Check each pattern
                for (var [patternId, pattern] of this.patterns) {
                    if (this.detectPattern(answers, pattern)) {
                        detectedPatterns.push({
                            id: patternId,
                            ...pattern,
                            confidence: this.calculateConfidence(answers, pattern)
                        });
                    }
                }

                return {
                    patterns: detectedPatterns,
                    riskLevel: riskLevel,
                    primaryPattern: this.identifyPrimaryPattern(detectedPatterns),
                    advancedCategory: this.determineAdvancedCategory(answers, detectedPatterns)
                };
            }

            detectPattern(answers, pattern) {
                var score = 0;
                for (var i = 0; i < pattern.triggers.length; i++) {
                    var trigger = pattern.triggers[i];
                    if (answers[trigger] !== undefined) {
                        score += answers[trigger] + 1; // Convert 0-3 to 1-4
                    }
                }
                return score >= pattern.threshold;
            }

            calculateConfidence(answers, pattern) {
                var totalScore = 0;
                var maxScore = 0;
                for (var i = 0; i < pattern.triggers.length; i++) {
                    var trigger = pattern.triggers[i];
                    if (answers[trigger] !== undefined) {
                        totalScore += answers[trigger] + 1;
                        maxScore += 4;
                    }
                }
                return Math.round((totalScore / maxScore) * 100);
            }

            calculateRiskLevel(answers) {
                var riskIndicators = [0, 3, 5, 7]; // Questions that indicate risk
                var riskScore = 0;
                
                for (var i = 0; i < riskIndicators.length; i++) {
                    var indicator = riskIndicators[i];
                    if (answers[indicator] !== undefined) {
                        riskScore += answers[indicator]; // 0-3 scale
                    }
                }

                if (riskScore <= 4) return 'low';
                if (riskScore <= 8) return 'medium';
                return 'high';
            }

            identifyPrimaryPattern(patterns) {
                if (patterns.length === 0) return null;
                return patterns.reduce(function(prev, current) {
                    return (prev.confidence > current.confidence) ? prev : current;
                });
            }

            determineAdvancedCategory(answers, patterns) {
                // AI logic to determine advanced category beyond basic 4
                for (var i = 0; i < patterns.length; i++) {
                    var pattern = patterns[i];
                    if (pattern.id === 'fomo_high') {
                        return this.advancedCategories.fomo_trader;
                    }
                    if (pattern.id === 'revenge_trading') {
                        return this.advancedCategories.revenge_trader;
                    }
                    if (pattern.id === 'analysis_paralysis') {
                        return this.advancedCategories.analysis_paralysis_trader;
                    }
                    if (pattern.id === 'impulsive_behavior') {
                        return this.advancedCategories.emotional_swing_trader;
                    }
                }
                
                // Default to disciplined but stressed if no major patterns
                return this.advancedCategories.disciplined_but_stressed;
            }

            generateDynamicRecommendations(analysisResult) {
                var recommendations = [];
                
                for (var i = 0; i < analysisResult.patterns.length; i++) {
                    var pattern = analysisResult.patterns[i];
                    var patternRecs = this.recommendations.get(pattern.id) || [];
                    recommendations = recommendations.concat(patternRecs);
                }

                // Add risk-level specific recommendations
                if (analysisResult.riskLevel === 'high') {
                    recommendations.unshift(
                        'URGENT: Consider reducing position sizes by 50% until emotional patterns improve',
                        'Implement daily trading journal with emotional state tracking'
                    );
                }

                // Remove duplicates
                return recommendations.filter(function(item, index) {
                    return recommendations.indexOf(item) === index;
                });
            }

            generatePersonalizedInsights(totalScore, analysisResult) {
                var insights = {
                    riskAlerts: [],
                    patterns: [],
                    recommendations: this.generateDynamicRecommendations(analysisResult),
                    personalizedTips: []
                };

                // Risk alerts based on detected patterns
                if (analysisResult.riskLevel === 'high') {
                    insights.riskAlerts.push({
                        level: 'high',
                        message: '‚ö†Ô∏è High-risk emotional patterns detected. Consider reducing position sizes.',
                        action: 'Implement strict risk management rules immediately'
                    });
                }

                // Pattern-specific insights
                for (var i = 0; i < analysisResult.patterns.length; i++) {
                    var pattern = analysisResult.patterns[i];
                    insights.patterns.push({
                        name: pattern.description,
                        confidence: pattern.confidence,
                        risk: pattern.risk
                    });
                }

                // Personalized tips based on score and patterns
                if (totalScore < 160) {
                    insights.personalizedTips.push(
                        'Focus on building emotional awareness before increasing position sizes',
                        'Consider paper trading to practice without financial pressure'
                    );
                } else if (totalScore > 250) {
                    insights.personalizedTips.push(
                        'Your psychology is strong - consider teaching or mentoring others',
                        'Focus on advanced risk management techniques'
                    );
                }

                return insights;
            }
        }

        // Initialize AI Engine
        var AI = new AIInsightsEngine();

        // ===== ENHANCED DATABASE WITH AI TRACKING =====
        
        class TradingAssessmentDatabase {
            constructor() {
                this.storageKey = 'trading_psychology_assessments';
                this.maxStorageSize = 1000;
                this.useLocalStorage = false;
                this.storageType = 'memory';
                this.loadData();
            }

            loadData() {
                try {
                    var testKey = 'localStorage_test';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    this.useLocalStorage = true;
                    this.storageType = 'localStorage';
                    
                    var stored = localStorage.getItem(this.storageKey);
                    this.data = stored ? JSON.parse(stored) : this.getDefaultData();
                    
                } catch (error) {
                    console.warn('localStorage not available, using in-memory storage:', error.message);
                    this.useLocalStorage = false;
                    this.storageType = 'memory';
                    this.data = this.getDefaultData();
                }
            }

            getDefaultData() {
                return {
                    assessments: [],
                    waitlist: [],
                    metadata: {
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        version: '3.0-AI',
                        totalSessions: 0,
                        storageType: this.storageType
                    }
                };
            }

            saveData() {
                try {
                    if (this.data.assessments.length > this.maxStorageSize) {
                        this.data.assessments = this.data.assessments.slice(-this.maxStorageSize);
                    }
                    
                    this.data.metadata.lastUpdated = new Date().toISOString();
                    this.data.metadata.totalSessions = this.data.assessments.length;
                    this.data.metadata.storageType = this.storageType;
                    
                    if (this.useLocalStorage) {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    }
                    
                    return true;
                } catch (error) {
                    console.warn('Error saving to localStorage, data stored in memory only:', error.message);
                    return false;
                }
            }

            addAssessment(assessment) {
                assessment.id = this.generateId();
                assessment.persistedAt = new Date().toISOString();
                this.data.assessments.push(assessment);
                return this.saveData();
            }

            addToWaitlist(email, userData = {}) {
                // Check if email already exists
                var existingEntry = this.data.waitlist.find(function(entry) {
                    return entry.email === email;
                });
                
                if (existingEntry) {
                    return false; // Already exists
                }
                
                var waitlistEntry = {
                    id: this.generateId(),
                    email: email,
                    signupDate: new Date().toISOString(),
                    source: 'ai_assessment',
                    userData: userData || {}
                };
                
                this.data.waitlist.push(waitlistEntry);
                return this.saveData();
            }

            getWaitlist() {
                return this.data.waitlist || [];
            }

            getWaitlistCount() {
                return this.data.waitlist ? this.data.waitlist.length : 0;
            }

            exportWaitlistToCSV() {
                var waitlist = this.data.waitlist || [];
                if (waitlist.length === 0) return null;

                var headers = ['Email', 'Signup Date', 'Source', 'User Score', 'AI Risk Level', 'Assessment Category'];
                
                var rows = waitlist.map(function(entry) {
                    return [
                        entry.email || '',
                        entry.signupDate || '',
                        entry.source || '',
                        entry.userData.totalScore || '',
                        entry.userData.aiRiskLevel || '',
                        entry.userData.category || ''
                    ];
                });

                var csvContent = [headers].concat(rows)
                    .map(function(row) { 
                        return row.map(function(field) { 
                            return '"' + String(field).replace(/"/g, '""') + '"'; 
                        }).join(','); 
                    })
                    .join('\n');

                return csvContent;
            }

            generateId() {
                return 'assess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            getAssessments() {
                return this.data.assessments;
            }

            getInsights() {
                var assessments = this.data.assessments;
                if (assessments.length === 0) return null;

                var insights = {
                    totalAssessments: assessments.length,
                    averageScore: this.calculateAverageScore(assessments),
                    categoryDistribution: this.getCategoryDistribution(assessments),
                    completionRate: this.getCompletionRate(assessments),
                    emailCaptureRate: this.getEmailCaptureRate(assessments),
                    pdfDownloadRate: this.getPdfDownloadRate(assessments),
                    timeAnalysis: this.getTimeAnalysis(assessments),
                    scoreDistribution: this.getScoreDistribution(assessments),
                    aiPatterns: this.getAIPatternInsights(assessments)
                };

                return insights;
            }

            getAIPatternInsights(assessments) {
                var patterns = {
                    fomoTraders: 0,
                    revengeTraders: 0,
                    analysisParalysis: 0,
                    impulsiveTraders: 0,
                    highRiskUsers: 0
                };

                for (var i = 0; i < assessments.length; i++) {
                    var assessment = assessments[i];
                    if (assessment.aiAnalysis) {
                        for (var j = 0; j < assessment.aiAnalysis.patterns.length; j++) {
                            var pattern = assessment.aiAnalysis.patterns[j];
                            if (pattern.id === 'fomo_high') patterns.fomoTraders++;
                            if (pattern.id === 'revenge_trading') patterns.revengeTraders++;
                            if (pattern.id === 'analysis_paralysis') patterns.analysisParalysis++;
                            if (pattern.id === 'impulsive_behavior') patterns.impulsiveTraders++;
                        }
                        
                        if (assessment.aiAnalysis.riskLevel === 'high') {
                            patterns.highRiskUsers++;
                        }
                    }
                }

                return patterns;
            }

            calculateAverageScore(assessments) {
                var completed = assessments.filter(function(a) { return a.completed; });
                return completed.length > 0 
                    ? Math.round(completed.reduce(function(sum, a) { return sum + a.totalScore; }, 0) / completed.length)
                    : 0;
            }

            getCategoryDistribution(assessments) {
                var dist = {};
                assessments.filter(function(a) { return a.completed; }).forEach(function(a) {
                    dist[a.category] = (dist[a.category] || 0) + 1;
                });
                return dist;
            }

            getCompletionRate(assessments) {
                return assessments.length > 0 
                    ? Math.round((assessments.filter(function(a) { return a.completed; }).length / assessments.length) * 100)
                    : 0;
            }

            getEmailCaptureRate(assessments) {
                var completed = assessments.filter(function(a) { return a.completed; });
                return completed.length > 0 
                    ? Math.round((completed.filter(function(a) { return a.emailProvided; }).length / completed.length) * 100)
                    : 0;
            }

            getPdfDownloadRate(assessments) {
                var withEmail = assessments.filter(function(a) { return a.emailProvided; });
                return withEmail.length > 0 
                    ? Math.round((withEmail.filter(function(a) { return a.pdfDownloaded; }).length / withEmail.length) * 100)
                    : 0;
            }

            getTimeAnalysis(assessments) {
                var completed = assessments.filter(function(a) { 
                    return a.completed && a.startTime && a.endTime; 
                });
                if (completed.length === 0) return null;

                var durations = completed.map(function(a) {
                    var start = new Date(a.startTime);
                    var end = new Date(a.endTime);
                    return (end - start) / 1000;
                });

                return {
                    averageDuration: Math.round(durations.reduce(function(a, b) { return a + b; }, 0) / durations.length),
                    minDuration: Math.min.apply(Math, durations),
                    maxDuration: Math.max.apply(Math, durations)
                };
            }

            getScoreDistribution(assessments) {
                var scores = assessments.filter(function(a) { return a.completed; }).map(function(a) { return a.totalScore; });
                return {
                    min: Math.min.apply(Math, scores) || 0,
                    max: Math.max.apply(Math, scores) || 0,
                    champion: scores.filter(function(s) { return s >= 280; }).length,
                    solid: scores.filter(function(s) { return s >= 200 && s < 280; }).length,
                    developing: scores.filter(function(s) { return s >= 120 && s < 200; }).length,
                    vulnerable: scores.filter(function(s) { return s < 120; }).length
                };
            }

            exportToCSV() {
                var assessments = this.data.assessments;
                if (assessments.length === 0) return null;

                var headers = [
                    'ID', 'Start Time', 'End Time', 'Duration (seconds)', 'Total Score', 'Category',
                    'Completed', 'Email Provided', 'PDF Downloaded', 'MailerLite Added',
                    'AI Risk Level', 'AI Primary Pattern', 'AI Advanced Category',
                    'Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8'
                ];

                var rows = assessments.map(function(a) {
                    var duration = a.startTime && a.endTime 
                        ? Math.round((new Date(a.endTime) - new Date(a.startTime)) / 1000)
                        : '';
                    
                    return [
                        a.id || a.sessionId,
                        a.startTime || '',
                        a.endTime || '',
                        duration,
                        a.totalScore || '',
                        a.category || '',
                        a.completed || false,
                        a.emailProvided || false,
                        a.pdfDownloaded || false,
                        a.mailerliteAdded || false,
                        a.aiAnalysis ? a.aiAnalysis.riskLevel : '',
                        a.aiAnalysis && a.aiAnalysis.primaryPattern ? a.aiAnalysis.primaryPattern.id : '',
                        a.aiAnalysis && a.aiAnalysis.advancedCategory ? a.aiAnalysis.advancedCategory.name : '',
                        a.answers && a.answers['0'] !== undefined ? a.answers['0'] : '',
                        a.answers && a.answers['1'] !== undefined ? a.answers['1'] : '',
                        a.answers && a.answers['2'] !== undefined ? a.answers['2'] : '',
                        a.answers && a.answers['3'] !== undefined ? a.answers['3'] : '',
                        a.answers && a.answers['4'] !== undefined ? a.answers['4'] : '',
                        a.answers && a.answers['5'] !== undefined ? a.answers['5'] : '',
                        a.answers && a.answers['6'] !== undefined ? a.answers['6'] : '',
                        a.answers && a.answers['7'] !== undefined ? a.answers['7'] : ''
                    ];
                });

                var csvContent = [headers].concat(rows)
                    .map(function(row) { 
                        return row.map(function(field) { 
                            return '"' + String(field).replace(/"/g, '""') + '"'; 
                        }).join(','); 
                    })
                    .join('\n');

                return csvContent;
            }

            exportToJSON() {
                return JSON.stringify(this.data, null, 2);
            }

            clearAll() {
                this.data = {
                    assessments: [],
                    waitlist: [],
                    metadata: {
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        version: '3.0-AI',
                        totalSessions: 0
                    }
                };
                return this.saveData();
            }

            backup() {
                var backup = {
                    data: this.data,
                    timestamp: new Date().toISOString(),
                    version: '3.0-AI'
                };
                
                var dataStr = JSON.stringify(backup, null, 2);
                var dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                var link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'trading_psychology_ai_backup_' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
            }
        }

        // Initialize Database
        var DB = new TradingAssessmentDatabase();

        // ===== ASSESSMENT LOGIC WITH AI ENHANCEMENT =====
        
        // MailerLite Configuration
        var MAILERLITE_API_TOKEN = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI0IiwianRpIjoiODNkZDhiMTY2ZTQ5MDY2NWY5YjQzMzU1ODM3YjBhZGM1OGU2YjU2OWFiOTg5MDg0ODEzNTAwYjFkZTFiMmFmMWNjMmM2MWFjNjQxZDFmZjciLCJpYXQiOjE3NDg5NTMyNDMuMDUwMDE3LCJuYmYiOjE3NDg5NTMyNDMuMDUwMDIsImV4cCI6NDkwNDYyNjg0My4wNDM5NTQsInN1YiI6IjE1ODEyNjkiLCJzY29wZXMiOltdfQ.irCclvaRLPuh5BCekhp1qR3A0ZyGWLP4wkMYolUsCCx3yx-V8V9V1p8CYP4nZbkwFiS8IzWUkilhgSTYqTwYmDeG9D2pQSwokSYWbZDsbVWwZtZVh-kW_gup0PfdBHdZGObddwQU7B_QZMKnlpqMgNPEBREweKxdMMadKZHHFf66gaAIkq5fcgNdGhQW8xXqDgUr2GahoisepokvD14aNRM3WEMkelkhOQ3AwALDbdLtkmlPegqNllik6Xw6ZDOIOSAkHikkBa9aZpfMQ0TPjOdy_6TfE9LxjDZ_-USQrCQuTiCQnxgvEjJDjhdGW2iIJIK9fLOIWrSVbBQg3xAC_idDk_eLqn-bEN1YNPeKeA7jT8FPaL4P5OxU3RryWg-f8KlWVNxgxXfifPawIMKIgescPCGJry7bbVTvRi-KgJViIWUl3N93QRSCPjXj7br8sB3dZtlRZk0oxwgzEP0394_778d4RR5Ns3WaeIB_e5DgNsj4tVzv-J2BAdOsiWwjFZnSWHZxrptgz3yQ-ZxCLkfnzLneadJueLeb2FTKMVpJGcassc_ibhu7K55bN8khSBr9tJ1Xlsx4f3vvsUPrYtqbcAipCwAGlCoM-UELouPwrqOYGGcvvlZUpINWaV49ZTE7KejBHnZcBLP8_ozO9Avr7wyemWNKbVvfg1yqYYA';
        var MAILERLITE_API_URL = 'https://connect.mailerlite.com/api';

        var MAILERLITE_GROUPS = {
            'champion': 'Champion Traders',
            'solid': 'Solid Traders',
            'developing': 'Developing Traders',
            'vulnerable': 'Vulnerable Traders'
        };

        var assessmentData = {
            sessionId: 'session_' + Date.now(),
            startTime: null,
            endTime: null,
            answers: {},
            totalScore: 0,
            category: '',
            completed: false,
            emailProvided: false,
            pdfDownloaded: false,
            mailerliteAdded: false,
            aiAnalysis: null,
            aiInsights: null
        };

        var questions = [
            {
                text: "When you experience a losing trade, what's your typical first reaction?",
                answers: [
                    "I immediately want to place a larger trade to recover losses",
                    "I feel frustrated but stick to my trading plan", 
                    "I analyze what went wrong before making another trade",
                    "I take a break from trading to clear my head"
                ]
            },
            {
                text: "How do you typically feel when you're in a winning position?",
                answers: [
                    "Excited and eager to increase my position size",
                    "Satisfied but focused on my exit strategy",
                    "Nervous about when to take profits",
                    "Confident in my analysis and plan"
                ]
            },
            {
                text: "What happens when the market moves against your analysis?",
                answers: [
                    "I hold on hoping it will turn around",
                    "I immediately exit according to my stop loss",
                    "I add to my position to average down",
                    "I feel stressed and have trouble deciding what to do"
                ]
            },
            {
                text: "How do you handle periods of consecutive losses?",
                answers: [
                    "I increase my position sizes to recover faster",
                    "I reduce my position sizes until I find my rhythm",
                    "I take a break from trading completely",
                    "I review and adjust my strategy"
                ]
            },
            {
                text: "When you see other traders making profits, you typically:",
                answers: [
                    "Feel like I'm missing out and rush into trades",
                    "Feel motivated to improve my own strategy",
                    "Compare my performance and feel discouraged",
                    "Stay focused on my own trading plan"
                ]
            },
            {
                text: "Your approach to risk management is:",
                answers: [
                    "I risk more when I'm confident about a trade",
                    "I use the same risk percentage on every trade",
                    "I adjust risk based on recent performance",
                    "I often forget to set stop losses"
                ]
            },
            {
                text: "How do you typically prepare for a trading session?",
                answers: [
                    "I jump right in when I see opportunities",
                    "I review my plan and check market conditions",
                    "I set daily profit/loss targets",
                    "I meditate or do mental preparation exercises"
                ]
            },
            {
                text: "When you're stressed during trading, you tend to:",
                answers: [
                    "Make impulsive decisions",
                    "Step away from the computer",
                    "Overtrade to relieve tension", 
                    "Stick rigidly to my rules"
                ]
            }
        ];

        var currentQuestion = 0;
        var userAnswers = [];

        // ===== ADMIN FUNCTIONS =====

        function toggleAdminPanel() {
            var panel = document.getElementById('admin-panel');
            var isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateAdminStats();
            }
        }

        function updateAdminStats() {
            var insights = DB.getInsights();
            var waitlistCount = DB.getWaitlistCount();
            var statsEl = document.getElementById('admin-stats');
            
            if (!insights) {
                statsEl.innerHTML = '<strong>üìä Quick Stats</strong><br>No data yet<br>Waitlist: ' + waitlistCount + '<br><small>Storage: ' + DB.storageType + '</small>';
                return;
            }

            var storageIcon = DB.useLocalStorage ? 'üíæ' : 'üß†';
            var storageText = DB.useLocalStorage ? 'Persistent' : 'Session Only';

            statsEl.innerHTML = '<strong>üìä AI-Enhanced Stats</strong><br>' +
                'Sessions: ' + insights.totalAssessments + '<br>' +
                'Avg Score: ' + insights.averageScore + '<br>' +
                'Completion: ' + insights.completionRate + '%<br>' +
                'Email Rate: ' + insights.emailCaptureRate + '%<br>' +
                'PDF Rate: ' + insights.pdfDownloadRate + '%<br>' +
                'üìß Waitlist: ' + waitlistCount + '<br>' +
                '<small>' + storageIcon + ' ' + storageText + '</small>';
        }

        function showAIPatterns() {
            var insights = DB.getInsights();
            if (!insights || !insights.aiPatterns) {
                alert('No AI pattern data available yet.');
                return;
            }

            var patterns = insights.aiPatterns;
            var report = 'üß† AI PATTERN ANALYSIS\n\n';
            
            report += 'EMOTIONAL PATTERNS DETECTED:\n';
            report += '‚Ä¢ FOMO Traders: ' + patterns.fomoTraders + '\n';
            report += '‚Ä¢ Revenge Traders: ' + patterns.revengeTraders + '\n';
            report += '‚Ä¢ Analysis Paralysis: ' + patterns.analysisParalysis + '\n';
            report += '‚Ä¢ Impulsive Traders: ' + patterns.impulsiveTraders + '\n';
            report += '‚Ä¢ High Risk Users: ' + patterns.highRiskUsers + '\n\n';

            var total = insights.totalAssessments;
            if (total > 0) {
                report += 'PATTERN PERCENTAGES:\n';
                report += '‚Ä¢ FOMO: ' + Math.round((patterns.fomoTraders/total)*100) + '%\n';
                report += '‚Ä¢ Revenge: ' + Math.round((patterns.revengeTraders/total)*100) + '%\n';
                report += '‚Ä¢ Analysis Paralysis: ' + Math.round((patterns.analysisParalysis/total)*100) + '%\n';
                report += '‚Ä¢ High Risk: ' + Math.round((patterns.highRiskUsers/total)*100) + '%\n';
            }

            alert(report);
        }

        function exportToCSV() {
            var csv = DB.exportToCSV();
            if (!csv) {
                alert('No data to export');
                return;
            }

            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'trading_psychology_ai_assessments_' + new Date().toISOString().split('T')[0] + '.csv');
            link.click();
        }

        function exportToJSON() {
            var json = DB.exportToJSON();
            var blob = new Blob([json], { type: 'application/json' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'trading_psychology_ai_data_' + new Date().toISOString().split('T')[0] + '.json');
            link.click();
        }

        function showWaitlistEmails() {
            var waitlist = DB.getWaitlist();
            if (waitlist.length === 0) {
                alert('üìß No waitlist emails yet.\n\nEmails will appear here when users join the waitlist for the Premium AI Toolkit.');
                return;
            }

            var report = 'üìß WAITLIST EMAILS (' + waitlist.length + ' total)\n\n';
            
            for (var i = 0; i < waitlist.length; i++) {
                var entry = waitlist[i];
                var date = new Date(entry.signupDate).toLocaleDateString();
                var score = entry.userData.totalScore ? ' (Score: ' + entry.userData.totalScore + ')' : '';
                report += (i + 1) + '. ' + entry.email + '\n';
                report += '   üìÖ ' + date + score + '\n\n';
            }

            report += '\nüí° Use "Export Waitlist" for CSV file with all details.';
            alert(report);
        }

        function exportWaitlist() {
            var csv = DB.exportWaitlistToCSV();
            if (!csv) {
                alert('No waitlist data to export');
                return;
            }

            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'premium_toolkit_waitlist_' + new Date().toISOString().split('T')[0] + '.csv');
            link.click();
            
            alert('üìß Waitlist exported successfully!\n\nYou can import this CSV into any email service.');
        }

        function showDetailedInsights() {
            var insights = DB.getInsights();
            if (!insights) {
                alert('No assessment data available yet.');
                return;
            }

            var report = 'üìä DETAILED AI-ENHANCED INSIGHTS\n\n';
            
            var storageIcon = DB.useLocalStorage ? 'üíæ' : 'üß†';
            var storageText = DB.useLocalStorage ? 'Persistent (localStorage)' : 'Session Only (memory)';
            report += 'üíæ Storage: ' + storageIcon + ' ' + storageText + '\n';
            if (!DB.useLocalStorage) {
                report += '‚ö†Ô∏è  Data will be lost on page refresh/close\n';
            }
            report += '\n';
            
            report += 'Total Assessments: ' + insights.totalAssessments + '\n';
            report += 'Average Score: ' + insights.averageScore + '/320\n';
            report += 'Completion Rate: ' + insights.completionRate + '%\n\n';
            
            report += 'üìà CONVERSION FUNNEL:\n';
            report += 'Started ‚Üí Completed: ' + insights.completionRate + '%\n';
            report += 'Completed ‚Üí Email: ' + insights.emailCaptureRate + '%\n';
            report += 'Email ‚Üí PDF: ' + insights.pdfDownloadRate + '%\n\n';
            
            report += 'üë• CATEGORY DISTRIBUTION:\n';
            Object.keys(insights.categoryDistribution).forEach(function(cat) {
                var count = insights.categoryDistribution[cat];
                var percentage = Math.round((count / insights.totalAssessments) * 100);
                report += cat.replace('_', ' ') + ': ' + count + ' (' + percentage + '%)\n';
            });

            if (insights.timeAnalysis) {
                report += '\n‚è±Ô∏è TIME ANALYSIS:\n';
                report += 'Average Duration: ' + Math.round(insights.timeAnalysis.averageDuration/60) + ' minutes\n';
                report += 'Fastest: ' + insights.timeAnalysis.minDuration + 's\n';
                report += 'Slowest: ' + Math.round(insights.timeAnalysis.maxDuration/60) + ' minutes\n';
            }

            report += '\nüìä SCORE DISTRIBUTION:\n';
            report += 'Champion (280+): ' + insights.scoreDistribution.champion + '\n';
            report += 'Solid (200-279): ' + insights.scoreDistribution.solid + '\n';
            report += 'Developing (120-199): ' + insights.scoreDistribution.developing + '\n';
            report += 'Vulnerable (<120): ' + insights.scoreDistribution.vulnerable + '\n';

            alert(report);
        }

        function backupData() {
            DB.backup();
            alert('AI-Enhanced backup downloaded successfully!');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL AI assessment data? This cannot be undone.')) {
                if (confirm('This will permanently delete all collected data including AI insights. Continue?')) {
                    DB.clearAll();
                    updateAdminStats();
                    alert('All data has been cleared.');
                }
            }
        }

        // ===== ASSESSMENT FUNCTIONS WITH AI =====

        function startAssessment() {
            gtag('event', 'ai_assessment_started', {
                event_category: 'ai_assessment',
                event_label: 'user_started_ai_assessment'
            });

            assessmentData.startTime = new Date().toISOString();
            
            document.getElementById('intro').style.display = 'none';
            document.getElementById('question-container').classList.add('active');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestion < questions.length) {
                var question = questions[currentQuestion];
                document.getElementById('question-text').textContent = question.text;
                
                var answersContainer = document.getElementById('answers');
                answersContainer.innerHTML = '';
                
                for (var i = 0; i < question.answers.length; i++) {
                    var answerDiv = document.createElement('div');
                    answerDiv.className = 'answer';
                    answerDiv.textContent = question.answers[i];
                    answerDiv.onclick = function(index) {
                        return function() { selectAnswer(index); };
                    }(i);
                    answersContainer.appendChild(answerDiv);
                }
                
                updateProgress();

                gtag('event', 'ai_question_viewed', {
                    event_category: 'ai_assessment',
                    event_label: 'question_' + (currentQuestion + 1)
                });
            } else {
                showResults();
            }
        }

        function selectAnswer(answerIndex) {
            assessmentData.answers[currentQuestion] = {
                question: currentQuestion,
                answer: answerIndex,
                timestamp: new Date().toISOString()
            };

            userAnswers[currentQuestion] = answerIndex;
            
            gtag('event', 'ai_answer_selected', {
                event_category: 'ai_assessment',
                event_label: 'q' + (currentQuestion + 1) + '_a' + (answerIndex + 1)
            });
            
            currentQuestion++;
            setTimeout(showQuestion, 300);
        }

        function updateProgress() {
            var progress = (currentQuestion / questions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function showResults() {
            assessmentData.endTime = new Date().toISOString();
            assessmentData.completed = true;

            // Calculate score
            var totalScore = 0;
            for (var i = 0; i < userAnswers.length; i++) {
                totalScore += (userAnswers[i] + 1) * 10;
            }
            
            assessmentData.totalScore = totalScore;
            
            // Determine basic category
            var category;
            if (totalScore >= 280) {
                category = 'champion_trader';
            } else if (totalScore >= 200) {
                category = 'solid_trader';
            } else if (totalScore >= 120) {
                category = 'developing_trader';
            } else {
                category = 'vulnerable_trader';
            }
            
            assessmentData.category = category;

            // ===== AI ANALYSIS =====
            assessmentData.aiAnalysis = AI.analyzePatterns(userAnswers);
            assessmentData.aiInsights = AI.generatePersonalizedInsights(totalScore, assessmentData.aiAnalysis);

            // Save to persistent storage
            DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));

            document.getElementById('question-container').classList.remove('active');
            document.getElementById('results-container').classList.add('active');
            
            var scoreCircle = document.getElementById('score-circle');
            scoreCircle.textContent = totalScore;
            scoreCircle.style.background = getScoreColor(totalScore);
            
            var resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = getResultsText(category);

            // Display AI insights
            displayAIInsights();

            // Generate QR code for sharing
            setTimeout(generateQRCode, 500);

            gtag('event', 'ai_assessment_completed', {
                event_category: 'ai_assessment',
                event_label: category,
                value: totalScore,
                custom_parameters: {
                    ai_risk_level: assessmentData.aiAnalysis.riskLevel,
                    ai_primary_pattern: assessmentData.aiAnalysis.primaryPattern ? assessmentData.aiAnalysis.primaryPattern.id : 'none'
                }
            });
        }

        function displayAIInsights() {
            var container = document.getElementById('ai-insights-container');
            var insights = assessmentData.aiInsights;
            var analysis = assessmentData.aiAnalysis;
            
            var html = '<div class="ai-insights">';
            html += '<h3>üß† AI-Enhanced Insights</h3>';
            
            // Risk alerts
            if (insights.riskAlerts.length > 0) {
                for (var i = 0; i < insights.riskAlerts.length; i++) {
                    var alert = insights.riskAlerts[i];
                    html += '<div class="risk-alerts ' + alert.level + '">';
                    html += '<strong>' + alert.message + '</strong><br>';
                    html += '<em>Recommended Action: ' + alert.action + '</em>';
                    html += '</div>';
                }
            }

            // Detected patterns
            if (insights.patterns.length > 0) {
                html += '<div class="pattern-detected">';
                html += '<strong>üéØ Detected Psychological Patterns:</strong><br>';
                for (var i = 0; i < insights.patterns.length; i++) {
                    var pattern = insights.patterns[i];
                    html += '‚Ä¢ ' + pattern.name + ' (' + pattern.confidence + '% confidence)<br>';
                }
                html += '</div>';
            }

            // Advanced category
            if (analysis.advancedCategory) {
                html += '<div class="personalized-tips">';
                html += '<strong>üè∑Ô∏è Advanced Classification:</strong><br>';
                html += '<span style="color: ' + analysis.advancedCategory.color + '; font-weight: bold;">';
                html += analysis.advancedCategory.name;
                html += '</span><br>';
                html += '<em>' + analysis.advancedCategory.description + '</em>';
                html += '</div>';
            }

            // Dynamic recommendations
            if (insights.recommendations.length > 0) {
                html += '<div class="personalized-tips">';
                html += '<strong>üéØ AI-Generated Recommendations:</strong><br>';
                for (var i = 0; i < Math.min(insights.recommendations.length, 3); i++) {
                    var rec = insights.recommendations[i];
                    html += (i + 1) + '. ' + rec + '<br>';
                }
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function getScoreColor(score) {
            if (score >= 280) return 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
            if (score >= 200) return 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
            if (score >= 120) return 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
            return 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        }

        function getResultsText(category) {
            var texts = {
                champion_trader: '<h3>Champion Trader üèÜ</h3><p>You demonstrate excellent emotional control and disciplined trading psychology. You have strong risk management skills and maintain composure under pressure.</p>',
                solid_trader: '<h3>Solid Trader üí™</h3><p>You have good trading psychology fundamentals with some areas for improvement. You generally maintain discipline but may struggle in high-stress situations.</p>',
                developing_trader: '<h3>Developing Trader üìà</h3><p>You show promise but need to work on emotional control and discipline. Focus on developing consistent risk management and stress management techniques.</p>',
                vulnerable_trader: '<h3>Vulnerable Trader ‚ö†Ô∏è</h3><p>Your emotions significantly impact your trading decisions. Consider taking a break to focus on psychology training and developing a solid trading plan before risking more capital.</p>'
            };
            return texts[category];
        }

        // MailerLite Integration
        async function addToMailerLite(email, firstName) {
            try {
                document.getElementById('loading').style.display = 'block';
                
                var groupName = getMailerLiteGroup(assessmentData.totalScore);
                
                var groupsResponse = await fetch(MAILERLITE_API_URL + '/groups', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + MAILERLITE_API_TOKEN,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!groupsResponse.ok) {
                    throw new Error('Failed to fetch groups');
                }

                var groupsData = await groupsResponse.json();
                var targetGroup = groupsData.data.find(function(group) {
                    return group.name === groupName;
                });

                if (!targetGroup) {
                    throw new Error('Group "' + groupName + '" not found');
                }

                var subscriberData = {
                    email: email,
                    fields: {
                        name: firstName || '',
                        assessment_score: assessmentData.totalScore,
                        trader_category: assessmentData.category,
                        ai_risk_level: assessmentData.aiAnalysis.riskLevel,
                        ai_primary_pattern: assessmentData.aiAnalysis.primaryPattern ? assessmentData.aiAnalysis.primaryPattern.id : '',
                        completion_date: new Date().toISOString()
                    },
                    groups: [targetGroup.id]
                };

                var addResponse = await fetch(MAILERLITE_API_URL + '/subscribers', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + MAILERLITE_API_TOKEN,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(subscriberData)
                });

                if (!addResponse.ok) {
                    var errorData = await addResponse.json();
                    throw new Error('MailerLite API error: ' + (errorData.message || 'Unknown error'));
                }

                var responseData = await addResponse.json();
                
                assessmentData.mailerliteAdded = true;
                assessmentData.mailerliteGroupId = targetGroup.id;
                assessmentData.mailerliteSubscriberId = responseData.data.id;

                DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));

                document.getElementById('loading').style.display = 'none';
                return true;

            } catch (error) {
                console.error('MailerLite integration failed:', error);
                document.getElementById('loading').style.display = 'none';
                
                alert('Email signup successful! Your personalized AI report is generating...');
                return false;
            }
        }

        function getMailerLiteGroup(score) {
            if (score >= 280) return MAILERLITE_GROUPS.champion;
            if (score >= 200) return MAILERLITE_GROUPS.solid;
            if (score >= 120) return MAILERLITE_GROUPS.developing;
            return MAILERLITE_GROUPS.vulnerable;
        }

        async function submitEmail() {
            var email = document.getElementById('email-input').value;
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            var firstName = email.split('@')[0].split('.')[0];
            firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
            
            gtag('event', 'ai_email_signup', {
                event_category: 'ai_conversion',
                event_label: 'email_captured',
                custom_parameters: {
                    ai_risk_level: assessmentData.aiAnalysis.riskLevel
                }
            });
            
            assessmentData.emailProvided = true;
            assessmentData.email = email;
            
            DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));
            
            await addToMailerLite(email, firstName);
            generatePersonalizedReport();
            
            alert('Success! You\'ve been added to your personalized AI-enhanced email series. Your comprehensive report is downloading now!');
        }

        // Enhanced PDF Generation with AI insights
        function generatePersonalizedReport() {
            try {
                // Safe jsPDF initialization
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                
                var jsPDF = window.jspdf.jsPDF;
                var doc = new jsPDF();
                var pageWidth = doc.internal.pageSize.getWidth();
                var pageHeight = doc.internal.pageSize.getHeight();
                var margin = 20;
                var yPos = 30;
                
                function drawSectionBox(x, y, w, h, color) {
                    doc.setFillColor(color[0], color[1], color[2]);
                    doc.rect(x, y, w, h, 'F');
                }
                
                // Header
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 50, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont("helvetica", "bold");
                doc.text("SCHNITZLEIN CONSULTING", pageWidth/2, 20, { align: 'center' });
                
                doc.setFontSize(18);
                doc.text("AI-Enhanced Trading Psychology Report", pageWidth/2, 32, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text("Dynamic Insights & Pattern Recognition", pageWidth/2, 42, { align: 'center' });
                
                // Disclaimer
                yPos = 60;
                doc.setFillColor(255, 248, 220);
                doc.setDrawColor(255, 193, 7);
                doc.setLineWidth(1);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 16, 'FD');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("IMPORTANT:", margin + 3, yPos + 6);
                doc.setFont("helvetica", "normal");
                doc.text("Educational AI analysis of emotional trading patterns - Not financial advice", margin + 25, yPos + 6);
                doc.text("For investment decisions, consult a licensed financial advisor", margin + 3, yPos + 12);
                
                // Assessment Results with AI
                yPos = 85;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("Your AI-Enhanced Assessment Results", margin, yPos);
                
                // Basic results
                doc.setFontSize(14);
                doc.text("Overall Score: " + assessmentData.totalScore + "/320", margin, yPos + 20);
                doc.text("Traditional Category: " + assessmentData.category.replace('_', ' ').toUpperCase(), margin, yPos + 30);
                
                // AI Analysis
                if (assessmentData.aiAnalysis && assessmentData.aiAnalysis.advancedCategory) {
                    doc.setTextColor(102, 126, 234);
                    doc.text("AI Advanced Classification: " + assessmentData.aiAnalysis.advancedCategory.name, margin, yPos + 40);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    doc.text(assessmentData.aiAnalysis.advancedCategory.description, margin, yPos + 48);
                }
                
                yPos += 60;
                
                // Risk Level
                if (assessmentData.aiAnalysis) {
                    var riskColor = assessmentData.aiAnalysis.riskLevel === 'high' ? [244, 67, 54] : 
                                   assessmentData.aiAnalysis.riskLevel === 'medium' ? [255, 152, 0] : [76, 175, 80];
                    
                    doc.setFillColor(riskColor[0], riskColor[1], riskColor[2]);
                    doc.rect(margin, yPos, 60, 15, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("helvetica", "bold");
                    doc.text("Risk Level: " + assessmentData.aiAnalysis.riskLevel.toUpperCase(), margin + 3, yPos + 10);
                    
                    yPos += 25;
                }
                
                // AI Detected Patterns
                if (assessmentData.aiInsights && assessmentData.aiInsights.patterns.length > 0) {
                    doc.setTextColor(102, 126, 234);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(14);
                    doc.text("AI-Detected Psychological Patterns", margin, yPos);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    yPos += 15;
                    
                    for (var i = 0; i < assessmentData.aiInsights.patterns.length; i++) {
                        var pattern = assessmentData.aiInsights.patterns[i];
                        doc.text("‚Ä¢ " + pattern.name + " (" + pattern.confidence + "% confidence)", margin + 5, yPos);
                        yPos += 8;
                    }
                    yPos += 5;
                }
                
                // Dynamic Recommendations
                if (assessmentData.aiInsights && assessmentData.aiInsights.recommendations.length > 0) {
                    if (yPos > 200) {
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    drawSectionBox(margin, yPos, pageWidth - 2 * margin, 40, [230, 240, 255]);
                    doc.setTextColor(0, 100, 200);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text("AI-Generated Personalized Recommendations", margin + 5, yPos + 10);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    
                    var recY = yPos + 18;
                    for (var i = 0; i < Math.min(assessmentData.aiInsights.recommendations.length, 5); i++) {
                        var rec = assessmentData.aiInsights.recommendations[i];
                        var wrappedLines = doc.splitTextToSize((i + 1) + ". " + rec, pageWidth - 2 * margin - 15);
                        for (var j = 0; j < wrappedLines.length; j++) {
                            doc.text(wrappedLines[j], margin + 5, recY);
                            recY += 5;
                        }
                    }
                    
                    yPos = recY + 10;
                }
                
                // Expert AI Insights Box
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 30;
                }
                
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(1);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 35);
                doc.setFillColor(245, 248, 255);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 35);
                
                doc.setTextColor(102, 126, 234);
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("AI Expert Analysis", margin + 5, yPos + 8);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                doc.text("This analysis uses advanced pattern recognition", margin + 5, yPos + 15);
                doc.text("algorithms trained on trading psychology research", margin + 5, yPos + 20);
                doc.text("to identify emotional patterns that impact", margin + 5, yPos + 25);
                doc.text("trading performance and provide personalized insights.", margin + 5, yPos + 30);
                
                // Footer
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(8);
                doc.text("¬© 2025 Schnitzlein Consulting - AI-Enhanced Trading Psychology Assessment", pageWidth/2, pageHeight - 10, { align: 'center' });
                
                // Update assessment data
                assessmentData.pdfDownloaded = true;
                DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));
                
                gtag('event', 'ai_pdf_download', {
                    event_category: 'ai_conversion',
                    event_label: 'ai_report_downloaded',
                    value: assessmentData.totalScore,
                    custom_parameters: {
                        ai_risk_level: assessmentData.aiAnalysis.riskLevel
                    }
                });
                
                doc.save("AI_Trading_Psychology_Report_" + Date.now() + ".pdf");
                
            } catch (error) {
                console.error('AI PDF generation failed:', error);
                alert('PDF generation failed, but your email signup was successful.');
            }
        }

        // ===== NEW OPTIMIZATION FUNCTIONS =====

        function joinWaitlist() {
            gtag('event', 'waitlist_interest', {
                event_category: 'conversion',
                event_label: 'premium_toolkit_waitlist',
                custom_parameters: {
                    user_score: assessmentData.totalScore,
                    ai_risk_level: assessmentData.aiAnalysis ? assessmentData.aiAnalysis.riskLevel : 'unknown'
                }
            });

            // Check if user already provided email
            if (assessmentData.emailProvided && assessmentData.email) {
                // Add existing user to waitlist with their assessment data
                var userData = {
                    totalScore: assessmentData.totalScore,
                    category: assessmentData.category,
                    aiRiskLevel: assessmentData.aiAnalysis ? assessmentData.aiAnalysis.riskLevel : '',
                    aiPrimaryPattern: assessmentData.aiAnalysis && assessmentData.aiAnalysis.primaryPattern ? assessmentData.aiAnalysis.primaryPattern.id : ''
                };
                
                var added = DB.addToWaitlist(assessmentData.email, userData);
                
                if (added) {
                    alert('üéâ Perfect! You\'ve been added to the Premium AI Toolkit waitlist!\n\n‚ú® Waitlist benefits:\n‚Ä¢ Early access\n‚Ä¢ Special pricing\n‚Ä¢ Exclusive features\n\nWe\'ll email you as soon as it\'s ready!');
                } else {
                    alert('‚úÖ You\'re already on our waitlist!\n\nWe\'ll notify you as soon as the Premium AI Toolkit launches.');
                }
                
                // Track waitlist signup
                gtag('event', 'waitlist_joined', {
                    event_category: 'conversion',
                    event_label: 'existing_email_user'
                });
                
            } else {
                // Prompt for email signup
                var email = prompt('üîî Join the Waitlist!\n\nEnter your email to get notified when the Advanced AI Toolkit launches:\n\n‚ú® Waitlist benefits:\n‚Ä¢ Early access\n‚Ä¢ Special pricing\n‚Ä¢ Exclusive features');
                
                if (email && email.includes('@')) {
                    // Add to waitlist with current assessment data if available
                    var userData = {
                        totalScore: assessmentData.totalScore || 0,
                        category: assessmentData.category || '',
                        aiRiskLevel: assessmentData.aiAnalysis ? assessmentData.aiAnalysis.riskLevel : '',
                        aiPrimaryPattern: assessmentData.aiAnalysis && assessmentData.aiAnalysis.primaryPattern ? assessmentData.aiAnalysis.primaryPattern.id : ''
                    };
                    
                    var added = DB.addToWaitlist(email, userData);
                    
                    if (added) {
                        alert('üéâ You\'re on the waitlist!\n\nWe\'ll email you as soon as the Advanced AI Toolkit is ready.\n\n‚ú® You\'ll get early access and special pricing!');
                    } else {
                        alert('‚úÖ You\'re already on our waitlist!\n\nWe\'ll notify you as soon as the Premium AI Toolkit launches.');
                    }
                    
                    // Track waitlist signup
                    gtag('event', 'waitlist_joined', {
                        event_category: 'conversion',
                        event_label: 'new_email_signup'
                    });
                    
                } else if (email) {
                    alert('Please enter a valid email address to join the waitlist.');
                }
            }
        }

        function copyAssessmentLink() {
            var assessmentUrl = window.location.origin + window.location.pathname;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(assessmentUrl).then(function() {
                    alert('‚úÖ Assessment link copied to clipboard!');
                }).catch(function() {
                    fallbackCopyTextToClipboard(assessmentUrl);
                });
            } else {
                fallbackCopyTextToClipboard(assessmentUrl);
            }

            gtag('event', 'link_shared', {
                event_category: 'sharing',
                event_label: 'copy_link'
            });
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                var msg = successful ? '‚úÖ Assessment link copied!' : '‚ùå Copy failed';
                alert(msg);
            } catch (err) {
                alert('‚ùå Copy failed. URL: ' + text);
            }

            document.body.removeChild(textArea);
        }

        function generateQRCode() {
            var canvas = document.getElementById('qr-code');
            var ctx = canvas.getContext('2d');
            
            // Simple QR code placeholder (you would integrate a real QR library for production)
            var size = 120;
            var cellSize = size / 25;
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // Create a simple pattern that resembles a QR code
            ctx.fillStyle = '#000000';
            
            // Finder patterns (corners)
            drawFinderPattern(ctx, 0, 0, cellSize);
            drawFinderPattern(ctx, 18 * cellSize, 0, cellSize);
            drawFinderPattern(ctx, 0, 18 * cellSize, cellSize);
            
            // Random data pattern
            for (var i = 0; i < 25; i++) {
                for (var j = 0; j < 25; j++) {
                    if (Math.random() > 0.5 && !isFinderArea(i, j)) {
                        ctx.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                    }
                }
            }
            
            // Add center text
            ctx.fillStyle = '#667eea';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('SCAN ME', size/2, size/2 + 20);
        }

        function drawFinderPattern(ctx, x, y, cellSize) {
            // Outer square
            ctx.fillRect(x, y, 7 * cellSize, 7 * cellSize);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x + cellSize, y + cellSize, 5 * cellSize, 5 * cellSize);
            ctx.fillStyle = '#000000';
            ctx.fillRect(x + 2 * cellSize, y + 2 * cellSize, 3 * cellSize, 3 * cellSize);
        }

        function isFinderArea(x, y) {
            return (x < 9 && y < 9) || (x > 15 && y < 9) || (x < 9 && y > 15);
        }

        function downloadQRCode() {
            var canvas = document.getElementById('qr-code');
            var link = document.createElement('a');
            link.download = 'trading_psychology_assessment_qr.png';
            link.href = canvas.toDataURL();
            link.click();

            gtag('event', 'qr_downloaded', {
                event_category: 'sharing',
                event_label: 'qr_code_download'
            });
        }

        // Global admin functions
        window.exportAssessmentData = exportToJSON;
        window.getAssessmentInsights = showDetailedInsights;
        window.clearAllAssessmentData = clearAllData;
        window.getAIPatterns = showAIPatterns;

        // Initialize admin stats on page load
        window.addEventListener('load', function() {
            var urlParams = new URLSearchParams(window.location.search);
            var isAdminStored = false;
            
            try {
                isAdminStored = localStorage.getItem('admin_mode') === 'true';
            } catch(e) {
                isAdminStored = false;
            }
            
            var isAdmin = urlParams.get('admin') === 'true' || 
                           window.location.hash === '#admin' ||
                           isAdminStored;
            
            if (isAdmin) {
                document.body.classList.add('admin-mode');
                updateAdminStats();
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                    document.body.classList.add('admin-mode');
                    updateAdminStats();
                    try {
                        localStorage.setItem('admin_mode', 'true');
                    } catch(e) {
                        console.log('Admin mode activated for this session only');
                    }
                }
            });
        });
    </script>
</body>
</html>
