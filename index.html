<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Psychology Assessment | Discover Your Emotional Trading Weaknesses</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7ZVV3LY8MS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7ZVV3LY8MS');
    </script>
    
    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "rt0249zmhv");
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .intro {
            text-align: center;
            margin-bottom: 40px;
        }

        .intro h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .intro p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            font-weight: 600;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .question-container {
            display: none;
            text-align: center;
        }

        .question-container.active {
            display: block;
        }

        .question {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .answers {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .answer {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .answer:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .answer.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-container {
            display: none;
            text-align: center;
        }

        .results-container.active {
            display: block;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
        }

        .email-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .email-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .email-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .email-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .email-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .disclaimer {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            margin-top: 20px;
            line-height: 1.4;
        }

        .loading {
            display: none;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
        }

        /* Admin Panel Styles */
        .admin-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .admin-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1001;
            display: none; /* Hidden by default */
        }

        /* Show admin only when ?admin=true in URL */
        .admin-mode .admin-toggle {
            display: block;
        }

        .admin-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 3px;
            width: 100%;
        }

        .admin-stats {
            font-size: 12px;
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .content { padding: 20px; }
            .email-form { flex-direction: column; }
            .email-input { margin-bottom: 10px; }
            .admin-panel { right: 5px; top: 5px; }
            .admin-toggle { right: 5px; top: 5px; }
        }
    </style>
</head>
<body>
    <!-- Admin Panel -->
    <button class="admin-toggle" onclick="toggleAdminPanel()">üìä Admin</button>
    <div class="admin-panel" id="admin-panel">
        <div class="admin-stats" id="admin-stats">Loading...</div>
        <button class="admin-button" onclick="exportToCSV()">üì• Export CSV</button>
        <button class="admin-button" onclick="exportToJSON()">üìÑ Export JSON</button>
        <button class="admin-button" onclick="showDetailedInsights()">üìä Insights</button>
        <button class="admin-button" onclick="backupData()">üíæ Backup</button>
        <button class="admin-button" onclick="clearAllData()">üóëÔ∏è Clear All</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Trading Psychology Assessment</h1>
            <p>Discover Your Emotional Trading Weaknesses</p>
        </div>

        <div class="content">
            <div class="intro" id="intro">
                <h2>Master Your Trading Psychology</h2>
                <p>Take our comprehensive assessment to identify emotional patterns that impact your trading performance. Get personalized insights and actionable strategies to improve your trading discipline.</p>
                
                <button class="start-button" onclick="startAssessment()">Start Assessment Now</button>
                
                <div class="disclaimer">
                    Educational analysis of emotional trading patterns - not financial advice. 
                    For investment decisions, consult a licensed financial advisor. 
                    By using this tool, you consent to analytics cookies for website improvement.
                </div>
            </div>

            <div class="question-container" id="question-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                
                <div class="question" id="question-text"></div>
                <div class="answers" id="answers"></div>
            </div>

            <div class="results-container" id="results-container">
                <h2>Your Trading Psychology Results</h2>
                <div class="score-circle" id="score-circle">0</div>
                <div id="results-content"></div>
                
                <div class="email-section">
                    <h3>Get Your Personalized Report & Join Our Email Series</h3>
                    <p>Enter your email to receive your detailed PDF report and personalized email strategies based on your trader type.</p>
                    <div class="email-form">
                        <input type="email" class="email-input" id="email-input" placeholder="Enter your email address" required>
                        <button class="email-button" onclick="submitEmail()">Get My Report</button>
                    </div>
                    <div class="loading" id="loading">‚è≥ Adding you to personalized email series...</div>
                    <div class="disclaimer">
                        You'll receive a personalized email series based on your assessment results. Unsubscribe anytime.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== PERSISTENT DATA STORAGE SYSTEM =====
        
        class TradingAssessmentDatabase {
            constructor() {
                this.storageKey = 'trading_psychology_assessments';
                this.maxStorageSize = 1000; // Max assessments to store
                this.useLocalStorage = false;
                this.storageType = 'memory';
                this.loadData();
            }

            loadData() {
                // Try localStorage first
                try {
                    const testKey = 'localStorage_test';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    this.useLocalStorage = true;
                    this.storageType = 'localStorage';
                    
                    const stored = localStorage.getItem(this.storageKey);
                    this.data = stored ? JSON.parse(stored) : this.getDefaultData();
                    
                } catch (error) {
                    // Fallback to in-memory storage
                    console.warn('localStorage not available, using in-memory storage:', error.message);
                    this.useLocalStorage = false;
                    this.storageType = 'memory';
                    this.data = this.getDefaultData();
                }
            }

            getDefaultData() {
                return {
                    assessments: [],
                    metadata: {
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        version: '2.0',
                        totalSessions: 0,
                        storageType: this.storageType
                    }
                };
            }

            saveData() {
                try {
                    // Cleanup old data if too large
                    if (this.data.assessments.length > this.maxStorageSize) {
                        this.data.assessments = this.data.assessments.slice(-this.maxStorageSize);
                    }
                    
                    this.data.metadata.lastUpdated = new Date().toISOString();
                    this.data.metadata.totalSessions = this.data.assessments.length;
                    this.data.metadata.storageType = this.storageType;
                    
                    if (this.useLocalStorage) {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    }
                    // In-memory storage always works (data persists during session)
                    
                    return true;
                } catch (error) {
                    console.warn('Error saving to localStorage, data stored in memory only:', error.message);
                    return false;
                }
            }

            addAssessment(assessment) {
                assessment.id = this.generateId();
                assessment.persistedAt = new Date().toISOString();
                this.data.assessments.push(assessment);
                return this.saveData();
            }

            generateId() {
                return 'assess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            getAssessments() {
                return this.data.assessments;
            }

            getInsights() {
                const assessments = this.data.assessments;
                if (assessments.length === 0) return null;

                const insights = {
                    totalAssessments: assessments.length,
                    averageScore: this.calculateAverageScore(assessments),
                    categoryDistribution: this.getCategoryDistribution(assessments),
                    completionRate: this.getCompletionRate(assessments),
                    emailCaptureRate: this.getEmailCaptureRate(assessments),
                    pdfDownloadRate: this.getPdfDownloadRate(assessments),
                    timeAnalysis: this.getTimeAnalysis(assessments),
                    scoreDistribution: this.getScoreDistribution(assessments)
                };

                return insights;
            }

            calculateAverageScore(assessments) {
                const completed = assessments.filter(a => a.completed);
                return completed.length > 0 
                    ? Math.round(completed.reduce((sum, a) => sum + a.totalScore, 0) / completed.length)
                    : 0;
            }

            getCategoryDistribution(assessments) {
                const dist = {};
                assessments.filter(a => a.completed).forEach(a => {
                    dist[a.category] = (dist[a.category] || 0) + 1;
                });
                return dist;
            }

            getCompletionRate(assessments) {
                return assessments.length > 0 
                    ? Math.round((assessments.filter(a => a.completed).length / assessments.length) * 100)
                    : 0;
            }

            getEmailCaptureRate(assessments) {
                const completed = assessments.filter(a => a.completed);
                return completed.length > 0 
                    ? Math.round((completed.filter(a => a.emailProvided).length / completed.length) * 100)
                    : 0;
            }

            getPdfDownloadRate(assessments) {
                const withEmail = assessments.filter(a => a.emailProvided);
                return withEmail.length > 0 
                    ? Math.round((withEmail.filter(a => a.pdfDownloaded).length / withEmail.length) * 100)
                    : 0;
            }

            getTimeAnalysis(assessments) {
                const completed = assessments.filter(a => a.completed && a.startTime && a.endTime);
                if (completed.length === 0) return null;

                const durations = completed.map(a => {
                    const start = new Date(a.startTime);
                    const end = new Date(a.endTime);
                    return (end - start) / 1000; // seconds
                });

                return {
                    averageDuration: Math.round(durations.reduce((a, b) => a + b, 0) / durations.length),
                    minDuration: Math.min(...durations),
                    maxDuration: Math.max(...durations)
                };
            }

            getScoreDistribution(assessments) {
                const scores = assessments.filter(a => a.completed).map(a => a.totalScore);
                return {
                    min: Math.min(...scores) || 0,
                    max: Math.max(...scores) || 0,
                    champion: scores.filter(s => s >= 280).length,
                    solid: scores.filter(s => s >= 200 && s < 280).length,
                    developing: scores.filter(s => s >= 120 && s < 200).length,
                    vulnerable: scores.filter(s => s < 120).length
                };
            }

            exportToCSV() {
                const assessments = this.data.assessments;
                if (assessments.length === 0) return null;

                const headers = [
                    'ID', 'Start Time', 'End Time', 'Duration (seconds)', 'Total Score', 'Category',
                    'Completed', 'Email Provided', 'PDF Downloaded', 'MailerLite Added',
                    'Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8'
                ];

                const rows = assessments.map(a => {
                    const duration = a.startTime && a.endTime 
                        ? Math.round((new Date(a.endTime) - new Date(a.startTime)) / 1000)
                        : '';
                    
                    return [
                        a.id || a.sessionId,
                        a.startTime || '',
                        a.endTime || '',
                        duration,
                        a.totalScore || '',
                        a.category || '',
                        a.completed || false,
                        a.emailProvided || false,
                        a.pdfDownloaded || false,
                        a.mailerliteAdded || false,
                        a.answers['0'] !== undefined ? a.answers['0'] : '',
                        a.answers['1'] !== undefined ? a.answers['1'] : '',
                        a.answers['2'] !== undefined ? a.answers['2'] : '',
                        a.answers['3'] !== undefined ? a.answers['3'] : '',
                        a.answers['4'] !== undefined ? a.answers['4'] : '',
                        a.answers['5'] !== undefined ? a.answers['5'] : '',
                        a.answers['6'] !== undefined ? a.answers['6'] : '',
                        a.answers['7'] !== undefined ? a.answers['7'] : ''
                    ];
                });

                const csvContent = [headers, ...rows]
                    .map(row => row.map(field => '"' + String(field).replace(/"/g, '""') + '"').join(','))
                    .join('\n');

                return csvContent;
            }

            exportToJSON() {
                return JSON.stringify(this.data, null, 2);
            }

            clearAll() {
                this.data = {
                    assessments: [],
                    metadata: {
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        version: '2.0',
                        totalSessions: 0
                    }
                };
                return this.saveData();
            }

            backup() {
                const backup = {
                    data: this.data,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `trading_psychology_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }
        }

        // Initialize Database
        const DB = new TradingAssessmentDatabase();

        // ===== ORIGINAL ASSESSMENT LOGIC =====
        
        // MailerLite Configuration
        const MAILERLITE_API_TOKEN = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI0IiwianRpIjoiODNkZDhiMTY2ZTQ5MDY2NWY5YjQzMzU1ODM3YjBhZGM1OGU2YjU2OWFiOTg5MDg0ODEzNTAwYjFkZTFiMmFmMWNjMmM2MWFjNjQxZDFmZjciLCJpYXQiOjE3NDg5NTMyNDMuMDUwMDE3LCJuYmYiOjE3NDg5NTMyNDMuMDUwMDIsImV4cCI6NDkwNDYyNjg0My4wNDM5NTQsInN1YiI6IjE1ODEyNjkiLCJzY29wZXMiOltdfQ.irCclvaRLPuh5BCekhp1qR3A0ZyGWLP4wkMYolUsCCx3yx-V8V9V1p8CYP4nZbkwFiS8IzWUkilhgSTYqTwYmDeG9D2pQSwokSYWbZDsbVWwZtZVh-kW_gup0PfdBHdZGObddwQU7B_QZMKnlpqMgNPEBREweKxdMMadKZHHFf66gaAIkq5fcgNdGhQW8xXqDgUr2GahoisepokvD14aNRM3WEMkelkhOQ3AwALDbdLtkmlPegqNllik6Xw6ZDOIOSAkHikkBa9aZpfMQ0TPjOdy_6TfE9LxjDZ_-USQrCQuTiCQnxgvEjJDjhdGW2iIJIK9fLOIWrSVbBQg3xAC_idDk_eLqn-bEN1YNPeKeA7jT8FPaL4P5OxU3RryWg-f8KlWVNxgxXfifPawIMKIgescPCGJry7bbVTvRi-KgJViIWUl3N93QRSCPjXj7br8sB3dZtlRZk0oxwgzEP0394_778d4RR5Ns3WaeIB_e5DgNsj4tVzv-J2BAdOsiWwjFZnSWHZxrptgz3yQ-ZxCLkfnzLneadJueLeb2FTKMVpJGcassc_ibhu7K55bN8khSBr9tJ1Xlsx4f3vvsUPrYtqbcAipCwAGlCoM-UELouPwrqOYGGcvvlZUpINWaV49ZTE7KejBHnZcBLP8_ozO9Avr7wyemWNKbVvfg1yqYYA';
        const MAILERLITE_API_URL = 'https://connect.mailerlite.com/api';

        // Group IDs mapping
        const MAILERLITE_GROUPS = {
            'champion': 'Champion Traders',
            'solid': 'Solid Traders',
            'developing': 'Developing Traders',
            'vulnerable': 'Vulnerable Traders'
        };

        // Current assessment data
        var assessmentData = {
            sessionId: 'session_' + Date.now(),
            startTime: null,
            endTime: null,
            answers: {},
            totalScore: 0,
            category: '',
            completed: false,
            emailProvided: false,
            pdfDownloaded: false,
            mailerliteAdded: false
        };

        // Trading Psychology Questions
        var questions = [
            {
                text: "When you experience a losing trade, what's your typical first reaction?",
                answers: [
                    "I immediately want to place a larger trade to recover losses",
                    "I feel frustrated but stick to my trading plan", 
                    "I analyze what went wrong before making another trade",
                    "I take a break from trading to clear my head"
                ]
            },
            {
                text: "How do you typically feel when you're in a winning position?",
                answers: [
                    "Excited and eager to increase my position size",
                    "Satisfied but focused on my exit strategy",
                    "Nervous about when to take profits",
                    "Confident in my analysis and plan"
                ]
            },
            {
                text: "What happens when the market moves against your analysis?",
                answers: [
                    "I hold on hoping it will turn around",
                    "I immediately exit according to my stop loss",
                    "I add to my position to average down",
                    "I feel stressed and have trouble deciding what to do"
                ]
            },
            {
                text: "How do you handle periods of consecutive losses?",
                answers: [
                    "I increase my position sizes to recover faster",
                    "I reduce my position sizes until I find my rhythm",
                    "I take a break from trading completely",
                    "I review and adjust my strategy"
                ]
            },
            {
                text: "When you see other traders making profits, you typically:",
                answers: [
                    "Feel like I'm missing out and rush into trades",
                    "Feel motivated to improve my own strategy",
                    "Compare my performance and feel discouraged",
                    "Stay focused on my own trading plan"
                ]
            },
            {
                text: "Your approach to risk management is:",
                answers: [
                    "I risk more when I'm confident about a trade",
                    "I use the same risk percentage on every trade",
                    "I adjust risk based on recent performance",
                    "I often forget to set stop losses"
                ]
            },
            {
                text: "How do you typically prepare for a trading session?",
                answers: [
                    "I jump right in when I see opportunities",
                    "I review my plan and check market conditions",
                    "I set daily profit/loss targets",
                    "I meditate or do mental preparation exercises"
                ]
            },
            {
                text: "When you're stressed during trading, you tend to:",
                answers: [
                    "Make impulsive decisions",
                    "Step away from the computer",
                    "Overtrade to relieve tension", 
                    "Stick rigidly to my rules"
                ]
            }
        ];

        var currentQuestion = 0;
        var userAnswers = [];

        // ===== ADMIN FUNCTIONS =====

        function toggleAdminPanel() {
            const panel = document.getElementById('admin-panel');
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateAdminStats();
            }
        }

        function updateAdminStats() {
            const insights = DB.getInsights();
            const statsEl = document.getElementById('admin-stats');
            
            if (!insights) {
                statsEl.innerHTML = `
                    <strong>üìä Quick Stats</strong><br>
                    No data yet<br>
                    <small>Storage: ${DB.storageType}</small>
                `;
                return;
            }

            const storageIcon = DB.useLocalStorage ? 'üíæ' : 'üß†';
            const storageText = DB.useLocalStorage ? 'Persistent' : 'Session Only';

            statsEl.innerHTML = `
                <strong>üìä Quick Stats</strong><br>
                Sessions: ${insights.totalAssessments}<br>
                Avg Score: ${insights.averageScore}<br>
                Completion: ${insights.completionRate}%<br>
                Email Rate: ${insights.emailCaptureRate}%<br>
                PDF Rate: ${insights.pdfDownloadRate}%<br>
                <small>${storageIcon} ${storageText}</small>
            `;
        }

        function exportToCSV() {
            const csv = DB.exportToCSV();
            if (!csv) {
                alert('No data to export');
                return;
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `trading_psychology_assessments_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        }

        function exportToJSON() {
            const json = DB.exportToJSON();
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `trading_psychology_data_${new Date().toISOString().split('T')[0]}.json`);
            link.click();
        }

        function showDetailedInsights() {
            const insights = DB.getInsights();
            if (!insights) {
                alert('No assessment data available yet.');
                return;
            }

            let report = `üìä DETAILED TRADING PSYCHOLOGY INSIGHTS\n\n`;
            
            // Storage info
            const storageIcon = DB.useLocalStorage ? 'üíæ' : 'üß†';
            const storageText = DB.useLocalStorage ? 'Persistent (localStorage)' : 'Session Only (memory)';
            report += `üíæ Storage: ${storageIcon} ${storageText}\n`;
            if (!DB.useLocalStorage) {
                report += `‚ö†Ô∏è  Data will be lost on page refresh/close\n`;
            }
            report += `\n`;
            
            report += `Total Assessments: ${insights.totalAssessments}\n`;
            report += `Average Score: ${insights.averageScore}/320\n`;
            report += `Completion Rate: ${insights.completionRate}%\n\n`;
            
            report += `üìà CONVERSION FUNNEL:\n`;
            report += `Started ‚Üí Completed: ${insights.completionRate}%\n`;
            report += `Completed ‚Üí Email: ${insights.emailCaptureRate}%\n`;
            report += `Email ‚Üí PDF: ${insights.pdfDownloadRate}%\n\n`;
            
            report += `üë• CATEGORY DISTRIBUTION:\n`;
            Object.entries(insights.categoryDistribution).forEach(([cat, count]) => {
                const percentage = Math.round((count / insights.totalAssessments) * 100);
                report += `${cat.replace('_', ' ')}: ${count} (${percentage}%)\n`;
            });

            if (insights.timeAnalysis) {
                report += `\n‚è±Ô∏è TIME ANALYSIS:\n`;
                report += `Average Duration: ${Math.round(insights.timeAnalysis.averageDuration/60)} minutes\n`;
                report += `Fastest: ${insights.timeAnalysis.minDuration}s\n`;
                report += `Slowest: ${Math.round(insights.timeAnalysis.maxDuration/60)} minutes\n`;
            }

            report += `\nüìä SCORE DISTRIBUTION:\n`;
            report += `Champion (280+): ${insights.scoreDistribution.champion}\n`;
            report += `Solid (200-279): ${insights.scoreDistribution.solid}\n`;
            report += `Developing (120-199): ${insights.scoreDistribution.developing}\n`;
            report += `Vulnerable (<120): ${insights.scoreDistribution.vulnerable}\n`;

            alert(report);
        }

        function backupData() {
            DB.backup();
            alert('Backup downloaded successfully!');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL assessment data? This cannot be undone.')) {
                if (confirm('This will permanently delete all collected data. Continue?')) {
                    DB.clearAll();
                    updateAdminStats();
                    alert('All data has been cleared.');
                }
            }
        }

        // ===== ASSESSMENT FUNCTIONS =====

        function startAssessment() {
            gtag('event', 'assessment_started', {
                event_category: 'assessment',
                event_label: 'user_started_assessment'
            });

            assessmentData.startTime = new Date().toISOString();
            
            document.getElementById('intro').style.display = 'none';
            document.getElementById('question-container').classList.add('active');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestion < questions.length) {
                var question = questions[currentQuestion];
                document.getElementById('question-text').textContent = question.text;
                
                var answersContainer = document.getElementById('answers');
                answersContainer.innerHTML = '';
                
                for (var i = 0; i < question.answers.length; i++) {
                    var answerDiv = document.createElement('div');
                    answerDiv.className = 'answer';
                    answerDiv.textContent = question.answers[i];
                    answerDiv.onclick = function(index) {
                        return function() { selectAnswer(index); };
                    }(i);
                    answersContainer.appendChild(answerDiv);
                }
                
                updateProgress();

                gtag('event', 'question_viewed', {
                    event_category: 'assessment',
                    event_label: 'question_' + (currentQuestion + 1)
                });
            } else {
                showResults();
            }
        }

        function selectAnswer(answerIndex) {
            assessmentData.answers[currentQuestion] = {
                question: currentQuestion,
                answer: answerIndex,
                timestamp: new Date().toISOString()
            };

            userAnswers[currentQuestion] = answerIndex;
            
            gtag('event', 'answer_selected', {
                event_category: 'assessment',
                event_label: 'q' + (currentQuestion + 1) + '_a' + (answerIndex + 1)
            });
            
            currentQuestion++;
            setTimeout(showQuestion, 300);
        }

        function updateProgress() {
            var progress = (currentQuestion / questions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function showResults() {
            assessmentData.endTime = new Date().toISOString();
            assessmentData.completed = true;

            // Calculate score
            var totalScore = 0;
            for (var i = 0; i < userAnswers.length; i++) {
                totalScore += (userAnswers[i] + 1) * 10;
            }
            
            assessmentData.totalScore = totalScore;
            
            // Determine category
            var category;
            if (totalScore >= 280) {
                category = 'champion_trader';
            } else if (totalScore >= 200) {
                category = 'solid_trader';
            } else if (totalScore >= 120) {
                category = 'developing_trader';
            } else {
                category = 'vulnerable_trader';
            }
            
            assessmentData.category = category;

            // Save to persistent storage
            DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));

            document.getElementById('question-container').classList.remove('active');
            document.getElementById('results-container').classList.add('active');
            
            var scoreCircle = document.getElementById('score-circle');
            scoreCircle.textContent = totalScore;
            scoreCircle.style.background = getScoreColor(totalScore);
            
            var resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = getResultsText(category);

            gtag('event', 'assessment_completed', {
                event_category: 'assessment',
                event_label: category,
                value: totalScore
            });
        }

        function getScoreColor(score) {
            if (score >= 280) return 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
            if (score >= 200) return 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
            if (score >= 120) return 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
            return 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        }

        function getResultsText(category) {
            var texts = {
                champion_trader: '<h3>Champion Trader üèÜ</h3><p>You demonstrate excellent emotional control and disciplined trading psychology. You have strong risk management skills and maintain composure under pressure.</p>',
                solid_trader: '<h3>Solid Trader üí™</h3><p>You have good trading psychology fundamentals with some areas for improvement. You generally maintain discipline but may struggle in high-stress situations.</p>',
                developing_trader: '<h3>Developing Trader üìà</h3><p>You show promise but need to work on emotional control and discipline. Focus on developing consistent risk management and stress management techniques.</p>',
                vulnerable_trader: '<h3>Vulnerable Trader ‚ö†Ô∏è</h3><p>Your emotions significantly impact your trading decisions. Consider taking a break to focus on psychology training and developing a solid trading plan before risking more capital.</p>'
            };
            return texts[category];
        }

        // MailerLite Integration (unchanged)
        async function addToMailerLite(email, firstName) {
            try {
                document.getElementById('loading').style.display = 'block';
                
                var groupName = getMailerLiteGroup(assessmentData.totalScore);
                
                const groupsResponse = await fetch(`${MAILERLITE_API_URL}/groups`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${MAILERLITE_API_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!groupsResponse.ok) {
                    throw new Error('Failed to fetch groups');
                }

                const groupsData = await groupsResponse.json();
                const targetGroup = groupsData.data.find(group => group.name === groupName);

                if (!targetGroup) {
                    throw new Error(`Group "${groupName}" not found`);
                }

                const subscriberData = {
                    email: email,
                    fields: {
                        name: firstName || '',
                        assessment_score: assessmentData.totalScore,
                        trader_category: assessmentData.category,
                        completion_date: new Date().toISOString()
                    },
                    groups: [targetGroup.id]
                };

                const addResponse = await fetch(`${MAILERLITE_API_URL}/subscribers`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${MAILERLITE_API_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(subscriberData)
                });

                if (!addResponse.ok) {
                    const errorData = await addResponse.json();
                    throw new Error(`MailerLite API error: ${errorData.message || 'Unknown error'}`);
                }

                const responseData = await addResponse.json();
                
                assessmentData.mailerliteAdded = true;
                assessmentData.mailerliteGroupId = targetGroup.id;
                assessmentData.mailerliteSubscriberId = responseData.data.id;

                // Update persistent storage
                DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));

                document.getElementById('loading').style.display = 'none';
                return true;

            } catch (error) {
                console.error('MailerLite integration failed:', error);
                document.getElementById('loading').style.display = 'none';
                
                alert('Email signup successful! Your personalized report is generating...');
                return false;
            }
        }

        function getMailerLiteGroup(score) {
            if (score >= 280) return MAILERLITE_GROUPS.champion;
            if (score >= 200) return MAILERLITE_GROUPS.solid;
            if (score >= 120) return MAILERLITE_GROUPS.developing;
            return MAILERLITE_GROUPS.vulnerable;
        }

        async function submitEmail() {
            var email = document.getElementById('email-input').value;
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            var firstName = email.split('@')[0].split('.')[0];
            firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
            
            gtag('event', 'email_signup', {
                event_category: 'conversion',
                event_label: 'email_captured'
            });
            
            assessmentData.emailProvided = true;
            assessmentData.email = email;
            
            // Update persistent storage
            DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));
            
            await addToMailerLite(email, firstName);
            generatePersonalizedReport();
            
            alert('Success! You\'ve been added to your personalized email series. Your PDF report is downloading now!');
        }

        // PDF Generation (unchanged but with persistent storage update)
        function generatePersonalizedReport() {
            try {
                var jsPDF = window.jspdf.jsPDF;
                var doc = new jsPDF();
                var pageWidth = doc.internal.pageSize.getWidth();
                var pageHeight = doc.internal.pageSize.getHeight();
                var margin = 20;
                var yPos = 30;
                
                function drawSectionBox(x, y, w, h, color) {
                    doc.setFillColor(color[0], color[1], color[2]);
                    doc.rect(x, y, w, h, 'F');
                }
                
                // Header
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 45, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont("helvetica", "bold");
                doc.text("SCHNITZLEIN CONSULTING", pageWidth/2, 20, { align: 'center' });
                
                doc.setFontSize(18);
                doc.text("Trading Psychology Report", pageWidth/2, 30, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text("Discover Your Emotional Trading Weaknesses", pageWidth/2, 38, { align: 'center' });
                
                // Disclaimer
                yPos = 55;
                doc.setFillColor(255, 248, 220);
                doc.setDrawColor(255, 193, 7);
                doc.setLineWidth(1);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 16, 'FD');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("IMPORTANT:", margin + 3, yPos + 6);
                doc.setFont("helvetica", "normal");
                doc.text("Educational analysis of emotional trading patterns - Not financial advice", margin + 25, yPos + 6);
                doc.text("For investment decisions, consult a licensed financial advisor", margin + 3, yPos + 12);
                
                // Assessment Results
                yPos = 80;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("Your Assessment Results", margin, yPos);
                
                // Visual Score Circle
                var scoreColor = getScoreColorRGB(assessmentData.totalScore);
                doc.setFillColor(scoreColor.r, scoreColor.g, scoreColor.b);
                doc.circle(margin + 25, yPos + 25, 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text(assessmentData.totalScore.toString(), margin + 25, yPos + 30, { align: 'center' });
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.text("Overall Score: " + assessmentData.totalScore + "/320", margin + 55, yPos + 20);
                doc.text("Category: " + assessmentData.category.replace('_', ' ').toUpperCase(), margin + 55, yPos + 30);
                
                yPos += 55;
                
                // Your Strengths
                drawSectionBox(margin, yPos, pageWidth - 2 * margin, 40, [230, 255, 230]);
                doc.setTextColor(0, 120, 0);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Your Strengths", margin + 5, yPos + 10);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                
                var strengthsText = getStrengthsForCategory(assessmentData.category);
                var strengthsSentences = strengthsText.split('. ');
                var strengthsY = yPos + 18;
                
                for (var i = 0; i < strengthsSentences.length; i++) {
                    if (strengthsSentences[i].trim()) {
                        var sentence = strengthsSentences[i].trim();
                        if (i < strengthsSentences.length - 1) sentence += '.';
                        
                        var wrappedLines = doc.splitTextToSize(sentence, pageWidth - 2 * margin - 15);
                        for (var j = 0; j < wrappedLines.length; j++) {
                            doc.text(wrappedLines[j], margin + 5, strengthsY);
                            strengthsY += 5;
                        }
                    }
                }
                
                yPos = strengthsY + 3;
                
                // Key Areas for Improvement
                drawSectionBox(margin, yPos, pageWidth - 2 * margin, 40, [255, 235, 215]);
                doc.setTextColor(180, 100, 0);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Key Areas for Improvement", margin + 5, yPos + 10);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                
                var improvementsText = getImprovementsForCategory(assessmentData.category);
                var improvementsSentences = improvementsText.split('. ');
                var improvementsY = yPos + 18;
                
                for (var i = 0; i < improvementsSentences.length; i++) {
                    if (improvementsSentences[i].trim()) {
                        var sentence = improvementsSentences[i].trim();
                        if (i < improvementsSentences.length - 1) sentence += '.';
                        
                        var wrappedLines = doc.splitTextToSize(sentence, pageWidth - 2 * margin - 15);
                        for (var j = 0; j < wrappedLines.length; j++) {
                            doc.text(wrappedLines[j], margin + 5, improvementsY);
                            improvementsY += 5;
                        }
                    }
                }
                
                yPos = improvementsY + 3;
                
                // Check for new page
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 30;
                }
                
                // Personalized Action Plan
                drawSectionBox(margin, yPos, pageWidth - 2 * margin, 50, [230, 240, 255]);
                doc.setTextColor(0, 100, 200);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Personalized Action Plan", margin + 5, yPos + 10);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                
                var actionPlan = getActionPlanForCategory(assessmentData.category);
                var actionItems = actionPlan.split('\n');
                var actionY = yPos + 18;
                
                for (var i = 0; i < actionItems.length; i++) {
                    if (actionItems[i].trim()) {
                        var wrappedLines = doc.splitTextToSize(actionItems[i].trim(), pageWidth - 2 * margin - 15);
                        for (var j = 0; j < wrappedLines.length; j++) {
                            doc.text(wrappedLines[j], margin + 5, actionY);
                            actionY += 5;
                        }
                    }
                }
                
                yPos = actionY + 3;
                
                // Expert Insights Box
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 30;
                }
                
                doc.setDrawColor(0, 100, 200);
                doc.setLineWidth(1);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 35);
                doc.setFillColor(245, 248, 255);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'F');
                doc.setDrawColor(0, 100, 200);
                doc.rect(margin, yPos, pageWidth - 2 * margin, 35);
                
                doc.setTextColor(0, 100, 200);
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("Expert Insight", margin + 5, yPos + 8);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                doc.text("Based on 10+ years of market experience", margin + 5, yPos + 15);
                doc.text("This analysis reflects common patterns seen in", margin + 5, yPos + 20);
                doc.text("successful traders who have overcome similar", margin + 5, yPos + 25);
                doc.text("psychological challenges.", margin + 5, yPos + 30);
                
                // Footer
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(8);
                doc.text("¬© 2025 Schnitzlein Consulting - Trading Psychology Assessment", pageWidth/2, pageHeight - 10, { align: 'center' });
                
                // Update assessment data and persistent storage
                assessmentData.pdfDownloaded = true;
                DB.addAssessment(JSON.parse(JSON.stringify(assessmentData)));
                
                gtag('event', 'pdf_download', {
                    event_category: 'conversion',
                    event_label: 'report_downloaded',
                    value: assessmentData.totalScore
                });
                
                doc.save("Trading_Psychology_Report_" + Date.now() + ".pdf");
                
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('PDF generation failed, but your email signup was successful.');
            }
        }

        // Helper functions for PDF content (unchanged)
        function getScoreColorRGB(score) {
            if (score >= 280) return {r: 76, g: 175, b: 80};
            if (score >= 200) return {r: 33, g: 150, b: 243};
            if (score >= 120) return {r: 255, g: 152, b: 0};
            return {r: 244, g: 67, b: 54};
        }

        function getStrengthsForCategory(category) {
            var strengths = {
                champion_trader: "You demonstrate exceptional emotional control and maintain discipline even during market volatility. Your risk management approach is consistent and you rarely let emotions override your trading plan. You have developed strong mental resilience and can handle both winning and losing streaks professionally.",
                solid_trader: "You have developed good foundational trading psychology skills and generally maintain composure during normal market conditions. Your approach to risk management is sound and you typically stick to your predetermined strategies. You show good self-awareness about your emotional triggers.",
                developing_trader: "You recognize the importance of trading psychology and are working to improve your emotional control. You have periods of good discipline but still struggle with consistency. Your awareness of psychological factors puts you ahead of many traders at your level.",
                vulnerable_trader: "You have the motivation to improve your trading psychology, which is the first crucial step. Your honesty in the assessment shows good self-awareness about areas that need work. This recognition is essential for developing better trading habits."
            };
            return strengths[category] || strengths.developing_trader;
        }

        function getImprovementsForCategory(category) {
            var improvements = {
                champion_trader: "Continue to refine your edge case management and consider mentoring other traders. Focus on scaling your successful approaches while maintaining your current discipline levels. Consider advanced risk management techniques for larger position sizes.",
                solid_trader: "Work on maintaining discipline during high-stress market conditions and consecutive losses. Develop better recovery strategies after emotional trading episodes. Consider implementing additional safeguards during volatile market periods.",
                developing_trader: "Focus on building consistent pre-trading routines and stick to predetermined position sizing rules. Develop better emotional awareness techniques and implement cooling-off periods after losses. Practice stress management techniques during trading hours.",
                vulnerable_trader: "Implement strict position sizing rules and never trade when emotionally compromised. Consider taking a break to focus on education and paper trading. Develop a comprehensive trading plan with clear rules for entry, exit, and risk management."
            };
            return improvements[category] || improvements.developing_trader;
        }

        function getActionPlanForCategory(category) {
            var actionPlans = {
                champion_trader: "1. Document your successful strategies for future reference\n2. Consider advanced risk management courses\n3. Explore mentoring opportunities\n4. Test new strategies with small position sizes\n5. Maintain regular performance reviews",
                solid_trader: "1. Implement a daily pre-trading mental checklist\n2. Set up automated stop-losses to reduce emotional decisions\n3. Keep a detailed trading journal focusing on emotional states\n4. Practice stress-reduction techniques\n5. Review and adjust your trading plan quarterly",
                developing_trader: "1. Start each day with a clear trading plan and stick to it\n2. Use position sizing calculator to maintain consistency\n3. Implement mandatory cooling-off periods after losses\n4. Join a trading psychology course or support group\n5. Practice mindfulness and emotional awareness exercises",
                vulnerable_trader: "1. Reduce position sizes to amounts that don't cause stress\n2. Take a 2-week break to focus on education\n3. Practice with paper trading only for the next month\n4. Read 'Trading in the Zone' by Mark Douglas\n5. Consider working with a trading psychology coach"
            };
            return actionPlans[category] || actionPlans.developing_trader;
        }

        // Global admin functions for console access
        window.exportAssessmentData = exportToJSON;
        window.getAssessmentInsights = showDetailedInsights;
        window.clearAllAssessmentData = clearAllData;

        // Initialize admin stats on page load
        window.addEventListener('load', function() {
            // Check if admin mode should be enabled
            const urlParams = new URLSearchParams(window.location.search);
            let isAdminStored = false;
            
            // Safe localStorage check
            try {
                isAdminStored = localStorage.getItem('admin_mode') === 'true';
            } catch(e) {
                // localStorage not available, ignore
                isAdminStored = false;
            }
            
            const isAdmin = urlParams.get('admin') === 'true' || 
                           window.location.hash === '#admin' ||
                           isAdminStored;
            
            if (isAdmin) {
                document.body.classList.add('admin-mode');
                updateAdminStats();
            }
            
            // Secret admin activation: Ctrl+Shift+A
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                    document.body.classList.add('admin-mode');
                    updateAdminStats();
                    try {
                        localStorage.setItem('admin_mode', 'true');
                    } catch(e) {
                        // localStorage not available, admin mode only for this session
                        console.log('Admin mode activated for this session only');
                    }
                }
            });
        });
    </script>
</body>
</html>
