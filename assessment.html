<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Psychology Assessment - Discover Your Trading Personality</title>
    <meta name="description" content="Free AI-powered trading psychology assessment. Discover your trader personality type and emotional patterns in 2 minutes.">
    
    <!-- Google Tag Manager (GTM) Head Code -->
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MB4F4HC8');
    </script>
    <!-- End Google Tag Manager -->
    
    <!-- Google Analytics (GA4) and Google Ads (Consent Mode v2) Integration -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17370771744"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        // Standardmäßig wird die Zustimmung verweigert (DSGVO-konform)
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'analytics_storage': 'denied'
        });

        // Google Ads Konfiguration (wird erst bei Consent = granted aktiviert)
        gtag('config', 'AW-17370771744'); 

        // Funktion zum Erteilen der Werbe-Zustimmung, aufgerufen vom Cookie Banner
        function grantAdConsent() {
            gtag('consent', 'update', {
                'ad_storage': 'granted',
                'ad_user_data': 'granted',
                'ad_personalization': 'granted'
            });
        }
    </script>
    
    <style>
        /* Allgemeine Styles für Body und Container */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
            min-height: 100vh;
            word-wrap: break-word; /* Added for global word breaking */
            overflow-wrap: break-word; /* Added for global word breaking */
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header-Bereich */
        .header {
            text-align: center;
            padding: 60px 20px 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .subtitle {
            font-size: 1.3em;
            color: #a0a0a0;
            margin-bottom: 30px;
        }

        .start-button, .next-button, .purchase-button {
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            color: #000;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .start-button:hover, .next-button:hover, .purchase-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.4);
        }

        .disclaimer-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9em;
            color: #a0a0a0;
            text-align: center;
        }

        .disclaimer-box a {
            color: #00d4ff;
            text-decoration: none;
        }

        /* Assessment-Container */
        .assessment-container {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .question {
            margin-bottom: 30px;
            display: none;
        }

        .question.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question h2 {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #1a1a1a;
        }

        .question h3 {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #333;
        }

        .options {
            display: grid;
            gap: 15px;
        }

        .option {
            padding: 20px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .option:hover {
            border-color: #00d4ff;
            background: #f0f8ff;
            transform: translateX(5px);
        }

        .option.selected {
            background: linear-gradient(135deg, #00ff8810 0%, #00d4ff10 100%);
            border-color: #00d4ff;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        /* Ergebnis-Bereich */
        .results {
            display: none;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .score-display {
            font-size: 4em;
            font-weight: 800;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        .trader-type {
            font-size: 2em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        .insights {
            text-align: left;
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            line-height: 1.8;
        }

        .insights h3 {
            color: #1a1a1a;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .insights p {
            margin-bottom: 15px;
        }

        .compliance-notice {
            background: #f0f8ff;
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.85em;
            color: #333;
        }

        .compliance-notice strong {
            color: #0066cc;
        }

        .purchase-section {
            margin: 40px 0;
        }

        .purchase-section h3 {
            font-size: 1.6em;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .purchase-section ul {
            list-style: none;
            padding: 0;
        }

        .purchase-section li {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .purchase-section li:before {
            content: "✓ ";
            color: #00ff88;
            font-weight: bold;
            margin-right: 10px;
        }

        .price-display {
            font-size: 1.5em;
            margin: 15px 0;
        }

        .price {
            color: #00ff88;
            font-weight: 800;
            font-size: 1.4em;
        }

        .email-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        #paypal-button-container {
            margin: 20px 0;
            min-height: 50px;
        }

        .waitlist-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .waitlist-section h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #1a1a1a;
        }

        .admin-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1a1f2e;
            color: #fff;
            padding: 30px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .admin-panel.open {
            right: 0;
        }

        .admin-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
        }

        .admin-stats {
            margin: 20px 0;
        }

        .stat-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            color: #a0a0a0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #00ff88;
        }

        .admin-button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
        }

        .admin-button:hover {
            background: #00d4ff;
        }

        .manual-paypal-button {
            background: #ffc439;
            color: #000;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(255, 196, 57, 0.3);
        }

        .manual-paypal-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 196, 57, 0.4);
        }

        .success-message {
            background: #00ff88;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }

        .error-message {
            background: #ef4444;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }

        .assessment-required-notice {
            background: #fbbf24;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .subtitle { font-size: 1.1em; }
            .question h2 { font-size: 1.4em; }
            .question h3 { font-size: 1.2em; }
            .admin-panel { width: 100%; }
            .container { padding: 10px; }
            .header { padding: 40px 20px 30px; }
            .assessment-container, .results { padding: 20px; }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MB4F4HC8"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <div class="header" id="header">
            <h1>AI Trading Psychology Assessment</h1>
            <p class="subtitle">Discover your trader personality type and unlock your potential</p>
            <button class="start-button" onclick="startAssessment()">Start Free Assessment</button>
            <p style="color: #a0a0a0; margin-top: 20px;">Takes only 2 minutes • No email required • 100% Free</p>
            
            <!-- Compliance Disclaimer -->
            <div class="disclaimer-box">
                <strong>Educational Purpose Only:</strong> This assessment provides psychological insights for educational purposes. 
                Not financial advice. Trading involves risk. 
                <a href="#" onclick="alert('This tool analyzes psychological patterns in trading behavior for educational purposes only. It does not provide financial advice, trading recommendations, or guarantee trading success. Always consult qualified financial advisors for investment decisions.')">Learn more</a>
            </div>
        </div>

        <div class="assessment-container" id="assessmentContainer">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div id="questionContainer"></div>
            <button class="next-button" onclick="nextQuestion()" style="display: none;">Next Question</button>
        </div>

        <div class="results" id="results">
            <h2>Your Trading Psychology Analysis</h2>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="trader-type" id="traderType"></div>
            <div class="insights" id="insights"></div>
            
            <!-- Conversion Tracking für assessment_complete -->
            <script>
              window.dataLayer = window.dataLayer || [];
              window.dataLayer.push({
                event: 'assessment_complete'
              });
            </script>
            
            <!-- Compliance Notice in Results -->
            <div class="compliance-notice">
                <strong>Important Notice:</strong> This psychological assessment is for educational and self-improvement purposes only. 
                Results should not be interpreted as financial advice or trading recommendations. 
                Past performance does not guarantee future results. Trading carries substantial risk of loss.
            </div>

            <div class="purchase-section">
                <h3>Get Your Complete 10-Page Psychology Analysis</h3>
                <p>Unlock deeper insights with your personalized report:</p>
                <ul style="text-align: left; margin: 20px auto; max-width: 500px;">
                    <li>Detailed personality breakdown with specific examples</li>
                    <li>Custom 90-day improvement plan tailored to your score</li>
                    <li>Risk management strategies designed for your personality type</li>
                    <li>Pattern recognition exercises to identify emotional triggers</li>
                    <li>Professional psychology toolkit with daily practices</li>
                    <li>Bonus: Access to future updates and tools</li>
                </ul>
                
                <div class="price-display">
                    <span class="price">NOW: $47</span>
                </div>

                <!-- Custom Email Form -->
                <div id="email-capture-form" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; margin: 20px auto; position: relative; z-index: 10;">
                    <h4 style="color: #00ff88; font-size: 24px; margin-bottom: 15px;">Get Your Free Analysis</h4>
                    <p style="color: #a0a0a0; font-size: 16px; margin-bottom: 20px;">Enter your email to receive your personalized results</p>
                    
                    <form id="emailForm" onsubmit="handleEmailSubmit(event); return false;">
                        <input type="email" 
                               id="userEmail" 
                               name="email"
                               placeholder="Enter your email to receive your report" 
                               required
                               autocomplete="email"
                               style="width: 100%; padding: 15px; font-size: 16px; background: rgba(255, 255, 255, 0.9); border: 2px solid #00d4ff; color: #000; border-radius: 10px; margin-bottom: 20px; outline: none; box-sizing: border-box;">
                        
                        <button type="submit" 
                                style="background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #000; font-weight: 700; padding: 15px 30px; font-size: 16px; border-radius: 50px; border: none; cursor: pointer; transition: all 0.3s ease; width: 100%; box-sizing: border-box;">
                            Get Your Personalized Report
                        </button>
                    </form>
                    
                    <div id="email-success" style="display: none; margin-top: 20px;">
                        <h4 style="color: #00ff88; font-size: 24px; margin-bottom: 15px;">Thank you!</h4>
                        <p style="color: #fff; font-size: 16px;">Your email has been saved. Complete your purchase below to receive your report.</p>
                    </div>
                </div>
                
                <!-- Assessment Required Notice -->
                <div id="assessment-required-notice" style="display: none;">
                    <div class="assessment-required-notice">
                        <p>⚠️ Please complete the assessment first to get your personalized report!</p>
                        <button class="start-button" onclick="location.reload()">Start Assessment Now</button>
                    </div>
                </div>
                
                <div id="paypal-button-container" style="display: none;"></div>
                
                <!-- Manual PayPal Fallback -->
                <div id="manual-paypal" style="display: none;">
                    <p style="color: #666; margin: 20px 0;">Or use PayPal directly:</p>
                    <button class="manual-paypal-button" onclick="manualPayPal()">
                        Pay with PayPal ($47)
                    </button>
                </div>
            </div>

            <div class="waitlist-section">
                <h3>Join the Waitlist for AI Trading Tools</h3>
                <p>Be first to access our upcoming AI-powered trading psychology tools:</p>
                <ul style="text-align: left; margin: 15px 0;">
                    <li>AI Psychology Tracker - Daily mood vs performance analysis</li>
                    <li>Real-time Emotion Monitor - Alerts before emotional trades</li>
                    <li>Advanced Risk Calculator - Based on your psychology profile</li>
                </ul>
                <form id="waitlistForm">
                    <input type="email" 
                           id="waitlistEmail" 
                           class="email-input" 
                           placeholder="Enter your email for early access" 
                           required>
                    <button type="submit" class="purchase-button">Join Waitlist</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Legal Footer -->
    <footer style="background: #0f1419; padding: 20px; text-align: center; border-top: 1px solid #333; margin-top: 40px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <p style="color: #8899a6; font-size: 14px; margin-bottom: 15px;">
                Educational Platform by Schnitzlein Consulting
            </p>
            <p style="color: #8899a6; font-size: 14px;">
                <a href="https://schnitzleinconsulting.com/impressum" target="_blank" style="color: #00ff88; text-decoration: none; margin: 0 10px;">Impressum</a>
                |
                <a href="https://schnitzleinconsulting.com/datenschutz" target="_blank" style="color: #00ff88; text-decoration: none; margin: 0 10px;">Datenschutz</a>
                |
                <a href="https://www.schnitzleinconsulting.com/en/datenschutz" target="_blank" style="color: #00ff88; text-decoration: none; margin: 0 10px;">Privacy Policy</a>
            </p>
            <p style="color: #666; font-size: 12px; margin-top: 15px;">
                © 2025 Schnitzlein Consulting - All Rights Reserved
            </p>
        </div>
    </footer>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <button class="admin-close" onclick="toggleAdminPanel()">&times;</button>
        <h2>Admin Dashboard</h2>
        <div class="admin-stats">
            <div class="stat-item">
                <div class="stat-label">Total Assessments</div>
                <div class="stat-value" id="totalAssessments">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Revenue</div>
                <div class="stat-value" id="totalRevenue">$0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Conversion Rate</div>
                <div class="stat-value" id="conversionRate">0%</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Waitlist Signups</div>
                <div class="stat-value" id="waitlistCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Average Score</div>
                <div class="stat-value" id="avgScore">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Storage Mode</div>
                <div class="stat-value" id="storageMode">checking...</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Score Distribution</div>
                <div id="scoreDistribution" style="font-size: 0.9em; margin-top: 10px;"></div>
            </div>
        </div>
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Actions</h3>
        <button class="admin-button" onclick="exportData()">Export All Data (CSV)</button>
        <button class="admin-button" onclick="testPurchase()">Test Purchase (Admin Only)</button>
        <button class="admin-button" onclick="clearAllData()">Clear All Data</button>
        <button class="admin-button" onclick="debugInfo()">Show Debug Info</button>
        <button class="admin-button" onclick="showDetailedStats()">Detailed Statistics</button>
    </div>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ===== KONFIGURATION =====
        const CONFIG = {
            regularPrice: 47,
            paypalEmail: 'th.schnitzlein@gmail.com',
            adminPassword: 'trading123', // BITTE ÄNDERN SIE DIESES PASSWORT IN EINER PRODUKTIONSUMGEBUNG!
            version: '4.4.0',
            analyticsEnabled: true
        };

        // ===== MAILERLITE INTEGRATION =====
        const MAILERLITE_CONFIG = {
            apiKey: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI0IiwianRpIjoiMWI0MDljMDMxZTViNjI5M2EyOWM3MjkzMTA4ZDFmN2M3NmYwMjczNTU3NGI1NmFhYjVjZGY3ZDljOGQ3NGIxNDhjMDI0MTU0ZTcwNTMwNzciLCJpYXQiOjE3NDk3MzI3ODEuMjk1NzcyLCJuYmYiOjE3NDk3MzI3ODEuMjk1Nzc2LCJleHAiOjQ5MDU0MDYzODEuMjg5ODI2LCJzdWIiOiIxNTgxMjY5Iiwic2NvcGVlcyI6W119.g64vCpQu8KxSIqctKKk03QyBKhgmEF6sfyN6rl68FraHRFRN1VbgCl-EgXXeo6aWUsW3PKotGcdbB0QXoi7Do21z6VQ7YctLspe8kyriSYILMV7k53zXgoxXe24puXA8bclXCsPaIO1uNepwZXNDAWaMHjY6DF9hdwFEh3ZedjnAB535UGzzU37wd-jQod_oVmbQznaRSyoWPz3JKMHgG345TZqgUdfLsrrm4zKdzJWWKfKVgxo7BoTKKrQhcBbRC3uRs3fTOQU9E_2D1HRDXFGhcHBwF5V3W973q8g9ADdXBw6zCIOvRrT88s7RvWUtOaEIn7s-_PqhXk4Y6KklunyFPzTccD6TzdOG5vTJnt3kfVGClTR1JcbnlBSzRsl2fXLoKlNQWKl5ectJvJ33snMlc2xBv4LmnrXKjGJOQB93YTOHuqLE6swJTZLDlVC2TibGOh4MejZDgDUNI8hQo1eCniLJ7JlJ1nbBcZo-6tkBF6PZhDeagQioajoR8nQTQ_kt1TBBn1l9uJbCJnPajDlYamLNfvcD-8JwJltWRIkCkUNqTmPKHmDo4w6-rq97-yww9untRWuFvKU-z59WA1C9_lCldf--X9zBHJj69i7rIgM_Hx9STXCOd5sa4WjsnmXkKE0RcqhKE_oujxzta5NujlgwpZPCCmTzw6GBgWs',
            apiUrl: 'https://connect.mailerlite.com/api',
            groups: {
                vulnerable: '156171765135967438', // 0-39: Risk Seeker
                developing: '156171536177300596', // 40-59: Emotional Challenger
                solid: '156171186694259782',      // 60-79: Evolving Trader
                champion: '156165764502521533'    // 80-100: Disciplined Strategist
            }
        };

        // Fixed Function to handle MailerLite form submission
        function handleMailerLiteSubmit() {
            const email = document.getElementById('mailerliteEmailInput').value;
            
            // Get score and trader type from session storage as backup
            const storedScore = sessionStorage.getItem('currentScore');
            const storedTraderType = sessionStorage.getItem('currentTraderType');
            
            // Use stored values if window values are missing
            if (!window.currentScore && storedScore) {
                window.currentScore = parseInt(storedScore);
            }
            if (!window.currentTraderType && storedTraderType) {
                window.currentTraderType = storedTraderType;
            }
            
            // Check if assessment has been completed
            if (!window.currentScore || !window.currentTraderType) {
                // Hide the form and show the notice
                document.getElementById('mlb2-27668853').style.display = 'none';
                document.getElementById('assessment-required-notice').style.display = 'block';
                
                // Track this event
                trackEvent('form_submit_without_assessment');
                
                return false; // Prevent form submission
            }
            
            if (email) {
                // Save email for later processing
                window.currentEmail = email;
                // The form will submit normally to MailerLite
                // After submission, we'll show PayPal options
                setTimeout(() => {
                    showPayPalOptions();
                }, 2000);
            }
            return true; // Allow form submission
        }

        function showPayPalOptions() {
            // Zeigt nur den manuellen PayPal-Button an
            document.getElementById('manual-paypal').style.display = 'block';
            // Entfernt den paypal-button-container, da wir das SDK nicht mehr verwenden
            document.getElementById('paypal-button-container').style.display = 'none'; 
        }

        // Handle email form submission
        function handleEmailSubmit(event) {
            event.preventDefault();
            
            const email = document.getElementById('userEmail').value;
            
            // Check if assessment has been completed
            if (!window.currentScore || !window.currentTraderType) {
                // Try to restore from sessionStorage
                const storedScore = sessionStorage.getItem('currentScore');
                const storedTraderType = sessionStorage.getItem('currentTraderType');
                
                if (storedScore && storedTraderType) {
                    window.currentScore = parseInt(storedScore);
                    window.currentTraderType = storedTraderType;
                } else {
                    // Hide the form and show the notice
                    document.getElementById('email-capture-form').style.display = 'none';
                    document.getElementById('assessment-required-notice').style.display = 'block';
                    trackEvent('email_submit_without_assessment');
                    return false;
                }
            }
            
            if (email && validateEmail(email)) {
                // Save email
                window.currentEmail = email;
                sessionStorage.setItem('currentEmail', email);
                
                // Hide form, show success
                document.getElementById('emailForm').style.display = 'none';
                document.getElementById('email-success').style.display = 'block';
                
                // Add to MailerLite via API in background
                addToMailerLiteAPI(email, window.currentScore, window.currentTraderType); // Hier wird window.currentScore übergeben
                
                // Show PayPal options
                showPayPalOptions();
                
                trackEvent('email_captured', { score: window.currentScore });
            }
            
            return false;
        }

        // Function to add subscriber to MailerLite API
        async function addToMailerLiteAPI(email, score, traderType) { // 'score' ist hier der Wert von window.currentScore
            console.log('Adding to MailerLite via API:', email, score, traderType);
            
            // Determine which group based on score
            let groupId;
            if (score < 40) {
                groupId = MAILERLITE_CONFIG.groups.vulnerable;
            } else if (score < 60) {
                groupId = MAILERLITE_CONFIG.groups.developing;
            } else if (score < 80) {
                groupId = MAILERLITE_CONFIG.groups.solid;
            } else {
                groupId = MAILERLITE_CONFIG.groups.champion;
            }

            try {
                const response = await fetch(`${MAILERLITE_CONFIG.apiUrl}/subscribers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${MAILERLITE_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        email: email,
                        groups: [groupId],
                        fields: {
                            ai_final_score: score, // HIER WURDE 'score' IN 'ai_final_score' UMGEBENANNT
                            trader_type: traderType,
                            assessment_date: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    console.log('✅ Successfully added to MailerLite group via API');
                    trackEvent('mailerlite_api_success', { score, traderType });
                } else {
                    const error = await response.text();
                    console.error('MailerLite API error:', response.status, error);
                    trackEvent('mailerlite_api_error', { status: response.status });
                }
            } catch (error) {
                console.error('MailerLite API integration error:', error);
                trackEvent('mailerlite_api_exception', { error: error.message });
            }
        }

        // MailerLite form success callback - not used anymore but kept for compatibility
        function ml_webform_success_27668853() {
            console.log('MailerLite form success callback (deprecated)');
        }

        // ===== ANALYTICS TRACKING (GT_TAG) =====
        function trackEvent(eventName, parameters = {}) {
            if (CONFIG.analyticsEnabled && typeof gtag !== 'undefined') {
                gtag('event', eventName, parameters);
            }
            console.log('Event tracked:', eventName, parameters);
        }

        // ===== ASSESSMENT QUESTIONS (DUMMY-DATEN) =====
        const questions = [
            {
                question: "After a losing trade, your first instinct is to:",
                options: [
                    { text: "Immediately enter another trade to recover losses", value: 10 },
                    { text: "Take a break and analyze what went wrong", value: 30 },
                    { text: "Stick to your plan and wait for the next setup", value: 40 },
                    { text: "Review your rules and only trade if criteria are met", value: 50 }
                ]
            },
            {
                question: "When you see others making profits on a trade you missed:",
                options: [
                    { text: "Jump in immediately, fearing you'll miss more", value: 10 },
                    { text: "Feel frustrated but wait for your own setup", value: 30 },
                    { text: "Analyze why you missed it for future improvement", value: 40 },
                    { text: "Stay focused on your own trading plan", value: 50 }
                ]
            },
            {
                question: "Your position sizing is determined by:",
                options: [
                    { text: "How confident I feel about the trade", value: 10 },
                    { text: "Recent wins or losses", value: 20 },
                    { text: "A fixed percentage, but I sometimes adjust", value: 35 },
                    { text: "Strict risk management rules, no exceptions", value: 50 }
                ]
            },
            {
                question: "When a trade moves against you:",
                options: [
                    { text: "Move your stop loss to avoid taking the loss", value: 10 },
                    { text: "Add to the position to average down", value: 15 },
                    { text: "Exit if it hits your stop, but it's painful", value: 35 },
                    { text: "Execute your exit plan without emotion", value: 50 }
                ]
            },
            {
                question: "Your trading journal includes:",
                options: [
                    { text: "I don't keep a trading journal", value: 10 },
                    { text: "Basic trade entries and exits", value: 25 },
                    { text: "Trades, results, and occasional notes", value: 35 },
                    { text: "Detailed analysis including emotional state", value: 50 }
                ]
            },
            {
                question: "After three winning trades in a row:",
                options: [
                    { text: "Increase position size - I'm on a hot streak", value: 10 },
                    { text: "Feel invincible and trade more frequently", value: 20 },
                    { text: "Stay cautious but feel more confident", value: 35 },
                    { text: "Maintain discipline - past results don't affect future trades", value: 50 }
                ]
            },
            {
                question: "Weekend planning consists of:",
                options: [
                    { text: "No planning - I react to the market", value: 10 },
                    { text: "Quick look at charts Sunday night", value: 25 },
                    { text: "Review last week and identify key levels", value: 35 },
                    { text : "Comprehensive analysis, journaling, and strategy review", value: 50 }
                ]
            },
            {
                question: "When you break your trading rules:",
                options: [
                    { text: "Justify it based on market conditions", value: 10 },
                    { text: "Feel guilty but do it anyway sometimes", value: 25 },
                    { text: "Rarely happens, but I document when it does", value: 40 },
                    { text: "Almost never - rules are non-negotiable", value: 50 }
                ]
            }
        ];

        let currentQuestion = 0;
        let answers = [];
        let assessmentData = {};
        let startTime = null;

        // ===== DATENVERWALTUNG MIT PERSISTENTEM SPEICHER =====
        // Erweiterter Speicher mit localStorage-Unterstützung
        let memoryStorage = {
            assessments: [],
            revenue: 0,
            waitlist: [],
            purchases: 0,
            version: CONFIG.version
        };

        // Prüfen, welche Speichertypen verfügbar sind
        function getAvailableStorage() {
            const storageTypes = {
                local: false,
                session: false,
                memory: true
            };
            
            // Teste localStorage
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                storageTypes.local = true;
                console.log('✅ localStorage verfügbar');
            } catch (e) {
                console.log('❌ localStorage nicht verfügbar');
            }
            
            // Teste sessionStorage
            try {
                const test = '__storage_test__';
                sessionStorage.setItem(test, test);
                sessionStorage.removeItem(test);
                storageTypes.session = true;
                console.log('✅ sessionStorage verfügbar');
            } catch (e) {
                console.log('❌ sessionStorage nicht verfügbar');
            }
            
            return storageTypes;
        }

        const availableStorage = getAvailableStorage();

        // Beste verfügbare Speichermethode ermitteln
        function getBestStorage() {
            if (availableStorage.local) return 'local';
            if (availableStorage.session) return 'session';
            return 'memory';
        }

        const storageMode = getBestStorage();

        // Vereinheitlichte Speicherfunktionen
        function getStoredData() {
            let data = null;
            
            // Zuerst localStorage versuchen (persistent)
            if (availableStorage.local) {
                try {
                    const stored = localStorage.getItem('tradingPsychologyData');
                    if (stored) {
                        data = JSON.parse(stored);
                        console.log('📦 Daten aus localStorage geladen');
                    }
                } catch (e) {
                    console.error('Fehler beim Lesen aus localStorage:', e);
                    // Bei Quota-Überschreitung versuchen, alte Daten zu bereinigen
                    if (e.name === 'QuotaExceededError') {
                        cleanupOldData(data);
                    }
                }
            }
            
            // Fallback auf sessionStorage
            if (!data && availableStorage.session) {
                try {
                    const stored = sessionStorage.getItem('tradingPsychologyData');
                    if (stored) {
                        data = JSON.parse(stored);
                        console.log('📦 Daten aus sessionStorage geladen');
                    }
                } catch (e) {
                    console.error('Fehler beim Lesen aus sessionStorage:', e);
                }
            }
            
            // Fallback auf Speicher (memory)
            if (!data) {
                data = memoryStorage;
                console.log('📦 Verwende In-Memory-Speicher');
            }
            
            // Sicherstellen, dass die Datenstruktur vollständig ist
            data = {
                assessments: data.assessments || [],
                revenue: data.revenue || 0,
                waitlist: data.waitlist || [],
                purchases: data.purchases || 0,
                purchaseDetails: data.purchaseDetails || [],
                version: data.version || CONFIG.version,
                lastUpdated: data.lastUpdated || new Date().toISOString()
            };
            
            return data;
        }

        function saveData(data) {
            data.lastUpdated = new Date().toISOString();
            data.version = CONFIG.version;
            
            let saved = false;
            
            // Zuerst localStorage versuchen (persistent)
            if (availableStorage.local) {
                try {
                    localStorage.setItem('tradingPsychologyData', JSON.stringify(data));
                    console.log('💾 Daten in localStorage gespeichert');
                    saved = true;
                } catch (e) {
                    console.error('Fehler beim Speichern in localStorage:', e);
                    // Bei Quota-Überschreitung versuchen, alte Daten zu bereinigen
                    if (e.name === 'QuotaExceededError') {
                        cleanupOldData(data);
                    }
                }
            }
            
            // Auch in sessionStorage als Backup speichern
            if (availableStorage.session) {
                try {
                    sessionStorage.setItem('tradingPsychologyData', JSON.stringify(data));
                    if (!saved) {
                        console.log('💾 Daten in sessionStorage gespeichert');
                        saved = true;
                    }
                } catch (e) {
                    console.error('Fehler beim Speichern in sessionStorage:', e);
                }
            }
            
            // Immer den In-Memory-Speicher aktualisieren
            memoryStorage = data;
            
            if (!saved) {
                console.warn('⚠️ Daten nur im Speicher (memory) gespeichert!');
            }
            
            // Backup in die Konsole für Notfallwiederherstellung
            console.log('🔒 Backup-Daten:', JSON.stringify(data));
        }

        // Bereinigungsfunktion für Speicherplatzprobleme
        function cleanupOldData(data) {
            console.log('🧹 Bereinige alte Daten...');
            
            // Nur die letzten 1000 Assessments behalten
            if (data.assessments.length > 1000) {
                data.assessments = data.assessments.slice(-1000);
            }
            
            // Nur die letzten 500 Kaufdetails behalten
            if (data.purchaseDetails && data.purchaseDetails.length > 500) {
                data.purchaseDetails = data.purchaseDetails.slice(-500);
            }
            
            // Duplikate aus der Warteliste entfernen
            data.waitlist = [...new Set(data.waitlist)];
            
            console.log('✅ Bereinigung abgeschlossen');
        }

        // Migrationsfunktion für alte Daten
        function migrateOldData() {
            // Prüfen, ob Daten in sessionStorage vorhanden sind, die migriert werden müssen
            if (availableStorage.session && availableStorage.local) {
                try {
                    const sessionData = sessionStorage.getItem('tradingPsychologyData');
                    const localData = localStorage.getItem('tradingPsychologyData');
                    
                    if (sessionData && !localData) {
                        // Von Session zu Local migrieren
                        localStorage.setItem('tradingPsychologyData', sessionData);
                        console.log('✅ Daten von sessionStorage nach localStorage migriert');
                    }
                } catch (e) {
                    console.error('Migrationsfehler:', e);
                }
            }
        }

        // Erweiterte Speicherfunktionen mit besserer Fehlerbehandlung
        function saveAssessment(score, traderType) {
            try {
                const data = getStoredData();
                const completionTime = startTime ? (Date.now() - startTime) / 1000 : 0;
                
                const assessment = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    score: score,
                    traderType: traderType,
                    timestamp: new Date().toISOString(),
                    answers: answers, // Komma hier hinzugefügt
                    completionTime: completionTime,
                    userAgent: navigator.userAgent,
                    referrer: document.referrer || 'direct',
                    source: getTrafficSource()
                };
                
                data.assessments.push(assessment);
                
                saveData(data);
                updateAdminPanel();
                trackEvent('assessment_completed', { score, traderType, completionTime });
                
                console.log('✅ Assessment gespeichert:', assessment.id);
            } catch (e) {
                console.error('❌ Fehler beim Speichern des Assessments:', e);
                alert('Warnung: Assessment-Daten wurden möglicherweise nicht korrekt gespeichert.');
            }
        }

        function savePurchase(email, transactionId = null) {
            try {
                const data = getStoredData();
                data.revenue += CONFIG.regularPrice;
                data.purchases += 1;
                
                const purchase = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    email: email,
                    amount: CONFIG.regularPrice,
                    timestamp: new Date().toISOString(),
                    transactionId: transactionId,
                    score: window.currentScore,
                    traderType: window.currentTraderType,
                    source: getTrafficSource()
                };
                
                if (!data.purchaseDetails) data.purchaseDetails = [];
                data.purchaseDetails.push(purchase);
                
                saveData(data);
                updateAdminPanel();
                trackEvent('purchase_completed', { amount: CONFIG.regularPrice, score: window.currentScore });
                
                console.log('✅ Kauf gespeichert:', purchase.id);
            } catch (e) {
                console.error('❌ Fehler beim Speichern des Kaufs:', e);
                alert('Warnung: Kaufdaten wurden möglicherweise nicht korrekt gespeichert.');
            }
        }

        function saveWaitlist(email) {
            try {
                const data = getStoredData();
                
                if (!data.waitlist.includes(email)) {
                    data.waitlist.push(email);
                    
                    // Auch detaillierten Wartelisten-Eintrag speichern
                    if (!data.waitlistDetails) data.waitlistDetails = [];
                    data.waitlistDetails.push({
                        email: email,
                        timestamp: new Date().toISOString(),
                        score: window.currentScore,
                        traderType: window.currentTraderType,
                        source: getTrafficSource()
                    });
                    
                    saveData(data);
                    updateAdminPanel();
                    trackEvent('waitlist_joined', { score: window.currentScore });
                    
                    console.log('✅ Wartelisten-Eintrag gespeichert:', email);
                }
            } catch (e) {
                console.error('❌ Fehler beim Speichern der Warteliste:', e);
            }
        }

        // Hilfsfunktion zur Identifizierung der Traffic-Quelle
        function getTrafficSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const referrer = document.referrer;
            
            if (urlParams.get('utm_source')) {
                return urlParams.get('utm_source');
            } else if (referrer.includes('twitter.com') || referrer.includes('x.com')) {
                return 'twitter';
            } else if (referrer.includes('youtube.com')) {
                return 'youtube';
            } else if (referrer.includes('google.com')) {
                return 'google';
            } else if (referrer) {
                return 'other';
            } else {
                return 'direct';
            }
        }

        // Erweiterte Admin-Panel-Aktualisierung mit Speicherinformationen
        function updateAdminPanel() {
            const data = getStoredData();
            
            document.getElementById('totalAssessments').textContent = data.assessments.length;
            document.getElementById('totalRevenue').textContent = `$${data.revenue}`;
            document.getElementById('waitlistCount').textContent = data.waitlist.length;
            
            const convRate = data.assessments.length > 0 
                ? ((data.purchases / data.assessments.length) * 100).toFixed(1) 
                : 0;
            document.getElementById('conversionRate').textContent = `${convRate}%`;
            
            const avgScore = data.assessments.length > 0
                ? Math.round(data.assessments.reduce((sum, a) => sum + a.score, 0) / data.assessments.length)
                : 0;
            document.getElementById('avgScore').textContent = avgScore;
            
            // Score-Verteilung
            updateScoreDistribution(data);
            
            // Speicher-Modus-Anzeige hinzufügen
            const storageIndicator = document.getElementById('storageMode');
            if (storageIndicator) {
                storageIndicator.textContent = `Speicher: ${storageMode}`;
                storageIndicator.style.color = storageMode === 'local' ? '#00ff88' : '#fbbf24';
            }
        }

        function updateScoreDistribution(data) {
            const distribution = {
                'Risk Seeker': 0,
                'Emotional Challenger': 0,
                'Evolving Trader': 0,
                'Disciplined Strategist': 0
            };
            
            data.assessments.forEach(assessment => {
                distribution[assessment.traderType]++;
            });
            
            const html = Object.entries(distribution)
                .map(([type, count]) => `${type}: ${count}`)
                .join('<br>');
                
            document.getElementById('scoreDistribution').innerHTML = html;
        }

        // ===== ASSESSMENT-FUNKTIONEN =====
        function startAssessment() {
            // Alte Assessment-Daten löschen
            try {
                sessionStorage.removeItem('currentScore');
                sessionStorage.removeItem('currentTraderType');
                sessionStorage.removeItem('assessmentCompleted');
                sessionStorage.removeItem('currentEmail');
            } catch (e) {
                console.log('Konnte sessionStorage nicht leeren:', e);
            }
            
            startTime = Date.now();
            document.getElementById('header').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('assessmentContainer').style.display = 'block';
            currentQuestion = 0;
            answers = [];
            showQuestion();
            trackEvent('assessment_started');
        }

        function showQuestion() {
            const container = document.getElementById('questionContainer');
            const question = questions[currentQuestion];
            
            container.innerHTML = `
                <div class="question active">
                    <h2>Question ${currentQuestion + 1} of ${questions.length}</h2>
                    <h3>${question.question}</h3>
                    <div class="options">
                        ${question.options.map((option, index) => `
                            <div class="option" onclick="selectOption(${index}, ${option.value})">
                                ${option.text}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            updateProgressBar();
        }

        function selectOption(index, value) {
            const options = document.querySelectorAll('.option');
            options.forEach(opt => opt.classList.remove('selected'));
            options[index].classList.add('selected');
            
            answers[currentQuestion] = value;
            
            document.getElementById('nextButton').style.display = 'block';
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion();
                document.getElementById('nextButton').style.display = 'none';
            } else {
                showResults();
            }
        }

        function updateProgressBar() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function calculateScore() {
            const sum = answers.reduce((a, b) => a + b, 0);
            const maxPossible = questions.length * 50;
            return Math.round((sum / maxPossible) * 100);
        }

        function getTraderType(score) {
            if (score >= 80) return { type: "Disciplined Strategist", color: "#00ff88" };
            if (score >= 60) return { type: "Evolving Trader", color: "#00d4ff" };
            if (score >= 40) return { type: "Emotional Challenger", color: "#fbbf24" };
            return { type: "Risk Seeker", color: "#ef4444" };
        }

        function getInsights(score, traderType) {
            const insights = {
                "Risk Seeker": {
                    strengths: "You're willing to take risks and have high energy for trading. Your enthusiasm and market engagement are assets that, when properly channeled, can lead to significant opportunities.",
                    weaknesses: "Emotional decision-making, revenge trading, and poor risk management are costing you money. You tend to let losses affect your judgment and often trade to 'get even' with the market.",
                    improvement: "Start with strict position sizing rules (never risk more than 1% per trade) and mandatory cool-down periods after losses. Consider paper trading for a week to practice discipline without financial financial risk.",
                    characteristics: "Risk Seekers often experience the highest highs and lowest lows in trading. Your emotional intensity can be both your greatest asset and biggest liability."
                },
                "Emotional Challenger": {
                    strengths: "You recognize that psychology matters and are working on improvement. This self-awareness puts you ahead of many traders who blame external factors for their losses.",
                    weaknesses: "Inconsistent discipline and emotional reactions still impact your results. You know the rules but struggle to follow them when emotions run high.",
                    improvement: "Implement a detailed trading journal including emotional states before, during, and after trades. Create a pre-market routine that includes meditation or breathing exercises.",
                    characteristics: "Emotional Challengers are in a transition phase. You're aware of your psychological challenges but haven't yet developed consistent habits to overcome them."
                },
                "Evolving Trader": {
                    strengths: "You have solid fundamentals and good awareness of trading psychology. Your discipline is improving, and you're beginning to see consistent results.",
                    weaknesses: "Occasional lapses in discipline during high-stress market conditions. You may still overtrade during volatile periods or hold onto losing positions too long.",
                    improvement: "Focus on advanced risk management techniques like portfolio heat and correlation analysis. Consider implementing a tier system for trade confidence levels.",
                    characteristics: "Evolving Traders are on the cusp of professional-level performance. Your main challenge is maintaining consistency across all market conditions."
                },
                "Disciplined Strategist": {
                    strengths: "Exceptional emotional control and consistent execution of your trading plan. You've mastered the psychological aspects that derail most traders.",
                    weaknesses: "May miss opportunities due to over-cautiousness. Sometimes your discipline can turn into rigidity, preventing adaptation to changing market conditions.",
                    improvement: "Consider gradually expanding your strategy repertoire while maintaining discipline. Explore systematic ways to identify and capitalize on higher-probability setups.",
                    characteristics: "Disciplined Strategists represent the top tier of trading psychology. Your challenge now is optimizing and scaling your approach."
                }
            };
            
            return insights[traderType];
        }

        function showResults() {
            const score = calculateScore();
            const traderInfo = getTraderType(score);
            const insights = getInsights(score, traderInfo.type);
            
            // Daten für spätere Verwendung speichern (window.currentScore wird hier gesetzt)
            window.currentScore = score;
            window.currentTraderType = traderInfo.type;
            
            // Auch in sessionStorage speichern, um Seitenneuladungen zu überleben
            try {
                sessionStorage.setItem('currentScore', score.toString());
                sessionStorage.setItem('currentTraderType', traderInfo.type);
                sessionStorage.setItem('assessmentCompleted', 'true');
            } catch (e) {
                console.log('Konnte nicht in sessionStorage speichern:', e);
            }
            
            assessmentData = {
                score: score,
                traderType: traderInfo.type,
                timestamp: new Date().toISOString(),
                answers: answers, 
                completionTime: completionTime,
                userAgent: navigator.userAgent,
                referrer: document.referrer || 'direct',
                source: getTrafficSource()
            };
            
            saveAssessment(score, traderInfo.type);
            
            document.getElementById('assessmentContainer').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            document.getElementById('scoreDisplay').textContent = `${score}/100`;
            document.getElementById('scoreDisplay').style.color = traderInfo.color;
            document.getElementById('traderType').textContent = traderInfo.type;
            
            document.getElementById('insights').innerHTML = `
                <h3>Your Psychology Profile:</h3>
                <p><strong>Strengths:</strong> ${insights.strengths}</p>
                <p><strong>Weaknesses:</strong> ${insights.weaknesses}</p>
                <p><strong>Improvement Focus:</strong> ${insights.improvement}</p>
                <p><strong>Your Profile:</strong> ${insights.characteristics}</p>
            `;
            
            // Hier wird das GA4-Event 'assessment_complete' ausgelöst
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                event: 'assessment_complete'
            });
        }

        // ===== PAYPAL INTEGRATION (VEREINFACHT) =====
        // Die Funktionen initializePayPal und renderPayPalButtons werden nicht mehr benötigt,
        // da wir das PayPal SDK nicht mehr direkt im iFrame laden und rendern.
        // Stattdessen wird direkt die manuelle PayPal-Option genutzt.

        // Manueller PayPal-Fallback
        function manualPayPal() {
            const email = window.currentEmail;
            if (!email || !validateEmail(email)) {
                alert('Bitte geben Sie zuerst eine gültige E-Mail-Adresse ein');
                return;
            }
            
            trackEvent('manual_paypal_clicked');
            
            // Öffnet PayPal in einem neuen Tab/Fenster
            const paypalUrl = `https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=${CONFIG.paypalEmail}&item_name=AI Trading Psychology Analysis&amount=${CONFIG.regularPrice}&currency_code=USD&return=${window.location.href}&cancel_return=${window.location.href}`;
            
            window.open(paypalUrl, '_blank');
            
            // Nach einer kurzen Pause den Benutzer fragen, ob die Zahlung abgeschlossen wurde
            setTimeout(() => {
                if (confirm('Haben Sie die PayPal-Zahlung abgeschlossen?')) {
                    handleSuccessfulPayment({ manual: true });
                }
            }, 3000); // 3 Sekunden Wartezeit
        }

        // Erfolgreiche Zahlung verarbeiten
        async function handleSuccessfulPayment(details) {
            const email = window.currentEmail;
            const score = window.currentScore || 0;
            const traderType = window.currentTraderType || '';
            
            const transactionId = details.id || 'manual_' + Date.now();
            savePurchase(email, transactionId);
            
            // PDF generieren
            generatePDF();
            
            // Erfolgsmeldung anzeigen
            const successHtml = `
                <div class="success-message">
                    <h3>✅ Zahlung erfolgreich!</h3>
                    <p>Vielen Dank für Ihren Kauf! Ihr personalisierter 10-seitiger Bericht wurde generiert und heruntergeladen.</p>
                    <p>Überprüfen Sie Ihre E-Mails unter <strong>${email}</strong> für zusätzliche Ressourcen und Ihre Willkommenssequenz.</p>
                    <p>Transaktions-ID: ${transactionId}</p>
                </div>
            `;
            
            document.querySelector('.purchase-section').innerHTML = successHtml;
            trackEvent('purchase_success', { transactionId });
        }

        // ===== ERWEITERTE PDF-GENERIERUNG MIT PREMIUM-DESIGN =====
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const score = window.currentScore;
            const traderType = window.currentTraderType;
            const insights = getInsights(score, traderType);
            
            // Benutzerdefinierte Farben basierend auf dem Trader-Typ
            const colors = {
                'Risk Seeker': { main: [239, 68, 68], light: [254, 226, 226], dark: [127, 29, 29] },
                'Emotional Challenger': { main: [251, 191, 36], light: [254, 243, 199], dark: [146, 64, 14] },
                'Evolving Trader': { main: [0, 212, 255], light: [224, 242, 254], dark: [7, 89, 133] },
                'Disciplined Strategist': { main: [0, 255, 136], light: [220, 252, 231], dark: [5, 150, 105] }
            };
            
            const typeColors = colors[traderType] || colors['Evolving Trader'];
            
            // Hilfsfunktion für Farbverlauf-Hintergründe
            function drawGradientRect(x, y, w, h, color1, color2) {
                const steps = 20;
                const stepHeight = h / steps;
                for (let i = 0; i < steps; i++) {
                    const ratio = i / steps;
                    const r = Math.round(color1[0] + (color2[0] - color1[0]) * ratio);
                    const g = Math.round(color1[1] + (color2[1] - color1[1]) * ratio);
                    const b = Math.round(color1[2] + (color2[2] - color1[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(x, y + (i * stepHeight), w, stepHeight, 'F');
                }
            }
            
            // Hilfsfunktion für abgerundete Rechtecke
            function drawRoundedRect(x, y, w, h, r, style = 'F') {
                doc.roundedRect(x, y, w, h, r, r, style);
            }
            
            // Hilfsfunktion für Abschnitts-Überschriften
            function drawSectionHeader(title, y) {
                // Hintergrund-Farbverlauf
                drawGradientRect(0, y - 10, 210, 25, typeColors.light, [255, 255, 255]);
                
                // Linker Akzentbalken
                doc.setFillColor(...typeColors.main);
                doc.rect(0, y - 10, 3, 25, 'F');
                
                // Kreis ohne Icon
                doc.setFillColor(...typeColors.main);
                doc.circle(15, y + 2, 8, 'F');
                
                // Titel
                doc.setTextColor(...typeColors.dark);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text(title, 30, y + 5);
                doc.setFont(undefined, 'normal');
            }
            
            // Hilfsfunktion für Infoboxen
            function drawInfoBox(x, y, w, h, content, bgColor = typeColors.light) {
                doc.setFillColor(...bgColor);
                doc.setDrawColor(...typeColors.main);
                doc.setLineWidth(0.5);
                drawRoundedRect(x, y, w, h, 5, 'FD');
                
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(11);
                const lines = doc.splitTextToSize(content, w - 10);
                doc.text(lines, x + 5, y + 8);
            }
            
            // ========== SEITE 1 - COVER ==========
            // Vollflächiger Farbverlauf-Hintergrund
            drawGradientRect(0, 0, 210, 297, typeColors.dark, typeColors.main);
            
            // Weiße Karte in der Mitte
            doc.setFillColor(255, 255, 255);
            drawRoundedRect(20, 50, 170, 180, 10);
            
            // Logo-Bereich (Farbverlauf-Kreis)
            doc.setFillColor(...typeColors.main);
            doc.circle(105, 90, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(36);
            doc.text('AI', 105, 98, { align: 'center' });
            
            // Titel
            doc.setTextColor(51, 51, 51);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('Trading Psychology', 105, 130, { align: 'center' });
            doc.setFontSize(18);
            doc.setFont(undefined, 'normal');
            doc.text('Personalized Analysis Report', 105, 145, { align: 'center' });
            
            // Score-Anzeige mit Kreisfortschritt
            doc.setDrawColor(...typeColors.main);
            doc.setLineWidth(8);
            doc.circle(105, 180, 20, 'S');
            
            doc.setTextColor(...typeColors.main);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(`${score}`, 105, 185, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('/100', 105, 195, { align: 'center' });
            
            // Trader-Typ-Badge
            doc.setFillColor(...typeColors.main);
            drawRoundedRect(40, 205, 130, 15, 7);
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(traderType, 105, 215, { align: 'center' });
            
            // Fußzeile
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Generiert am: ' + new Date().toLocaleDateString(), 105, 250, { align: 'center' });
            doc.text('© 2025 Schnitzlein Consulting', 105, 260, { align: 'center' });
            
            // Weitere Seiten hinzufügen (hier nur die Kernstruktur zur Kürze)
            // In der Produktion sollten alle 10 Seiten mit detailliertem Inhalt hinzugefügt werden
            
            // PDF speichern
            doc.save(`Trading_Psychology_Report_${score}_${traderType.replace(/\s+/g, '_')}.pdf`);
            trackEvent('pdf_generated', { score, traderType });
        }

        // ===== HILFSFUNKTIONEN =====
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // ===== WARTELISTEN-FUNKTIONALITÄT =====
        document.getElementById('waitlistForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('waitlistEmail').value;
            
            if (!validateEmail(email)) {
                alert('Bitte geben Sie eine gültige E-Mail-Adresse ein');
                return;
            }
            
            const score = window.currentScore || 0;
            const traderType = window.currentTraderType || '';
            
            // Zu MailerLite über API hinzufügen
            await addToMailerLiteAPI(email, score, traderType);
            
            saveWaitlist(email);
            
            document.getElementById('waitlistForm').innerHTML = 
                '<p style="color: #00ff88; font-weight: 600;">✓ Erfolgreich der Warteliste beigetreten! Überprüfen Sie Ihre E-Mails zur Bestätigung.</p>';
        });

        // ===== ADMIN-PANEL-FUNKTIONEN =====
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('open');
        }

        function exportData() {
            const data = getStoredData();
            
            // CSV-Inhalt erstellen
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Type,Score,TraderType,Timestamp,CompletionTime,Referrer,Email,Amount\n";
            
            // Assessments hinzufügen
            data.assessments.forEach(assessment => {
                csvContent += `Assessment,${assessment.score},"${assessment.traderType}","${assessment.timestamp}",${assessment.completionTime || ''},"${assessment.referrer || ''}","",""\n`;
            });
            
            // Käufe hinzufügen
            if (data.purchaseDetails) {
                data.purchaseDetails.forEach(purchase => {
                    csvContent += `Purchase,${purchase.score || ''},"${purchase.traderType || ''}","${purchase.timestamp}","","","${purchase.email}",${purchase.amount}\n`;
                });
            }
            
            // Warteliste hinzufügen
            data.waitlist.forEach(email => {
                csvContent += `Waitlist,"","","${new Date().toISOString()}","","","${email}",""\n`;
            });
            
            // CSV herunterladen
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `trading_assessments_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            trackEvent('data_exported');
        }

        function testPurchase() {
            if (confirm('Dies simuliert einen Kauf zu Testzwecken. Fortfahren?')) {
                handleSuccessfulPayment({ test: true, id: 'TEST_' + Date.now() });
            }
        }

        // Erweiterte Funktion zum Löschen von Daten
        function clearAllData() {
            if (confirm('Sind Sie sicher, dass Sie alle Daten löschen möchten? Dies kann nicht rückgängig gemacht werden.')) {
                const password = prompt('Geben Sie das Admin-Passwort ein:');
                if (password === CONFIG.adminPassword) {
                    // Alle Speichertypen löschen
                    if (availableStorage.local) {
                        localStorage.removeItem('tradingPsychologyData');
                    }
                    if (availableStorage.session) {
                        sessionStorage.removeItem('tradingPsychologyData');
                    }
                    
                    // In-Memory-Speicher zurücksetzen
                    memoryStorage = {
                        assessments: [],
                        revenue: 0,
                        waitlist: [],
                        purchases: 0,
                        version: CONFIG.version
                    };
                    
                    updateAdminPanel();
                    alert('Alle Daten erfolgreich von allen Speichertypen gelöscht');
                    trackEvent('data_cleared');
                } else {
                    alert('Falsches Passwort');
                }
            }
        }

        // Erweiterte Debug-Informationen
        function debugInfo() {
            const data = getStoredData();
            console.log('=== Debug-Informationen ===');
            console.log('Version:', CONFIG.version);
            console.log('Verfügbare Speichertypen:', availableStorage);
            console.log('Aktueller Speichermodus:', storageMode);
            console.log('Datenspeicherort:', {
                localStorage: availableStorage.local ? (localStorage.getItem('tradingPsychologyData') ? 'Hat Daten' : 'Leer') : 'Nicht verfügbar',
                sessionStorage: availableStorage.session ? (sessionStorage.getItem('tradingPsychologyData') ? 'Hat Daten' : 'Leer') : 'Nicht verfügbar',
                memory: 'Immer verfügbar'
            });
            console.log('Daten:', data);
            console.log('Datengröße:', new Blob([JSON.stringify(data)]).size + ' Bytes');
            console.log('Aktueller Score:', window.currentScore);
            console.log('Aktueller Trader-Typ:', window.currentTraderType);
            console.log('User Agent:', navigator.userAgent);
            console.log('Referrer:', document.referrer || 'none');
            console.log('URL-Parameter:', new URLSearchParams(window.location.search).toString());
            
            alert(`Debug-Info:\nSpeicher: ${storageMode}\nAssessments: ${data.assessments.length}\nUmsatz: $${data.revenue}\n\nDrücken Sie F12 für detaillierte Konsolenprotokolle`);
        }

        function showDetailedStats() {
            const data = getStoredData();
            
            let stats = '=== Detaillierte Statistiken ===\n\n';
            stats += `Gesamtzahl Assessments: ${data.assessments.length}\n`;
            stats += `Gesamtumsatz: $${data.revenue}\n`;
            stats += `Conversion-Rate: ${data.assessments.length > 0 ? ((data.purchases / data.assessments.length) * 100).toFixed(1) : 0}%\n`;
            stats += `Durchschnittlicher Score: ${data.assessments.length > 0 ? Math.round(data.assessments.reduce((sum, a) => sum + a.score, 0) / data.assessments.length) : 0}\n\n`;
            
            stats += 'Score-Verteilung:\n';
            const distribution = {
                'Risk Seeker': 0,
                'Emotional Challenger': 0,
                'Evolving Trader': 0,
                'Disciplined Strategist': 0
            };
            
            data.assessments.forEach(assessment => {
                distribution[assessment.traderType]++;
            });
            
            Object.entries(distribution).forEach(([type, count]) => {
                const percentage = data.assessments.length > 0 ? ((count / data.assessments.length) * 100).toFixed(1) : 0;
                stats += `${type}: ${count} (${percentage}%)\n`;
            });
            
            if (data.assessments.length > 0) {
                stats += '\nDurchschnittliche Abschlusszeit: ' + 
                    (data.assessments.reduce((sum, a) => sum + (a.completionTime || 0), 0) / 
                    data.assessments.filter(a => a.completionTime).length).toFixed(1) + ' Sekunden\n';
            }
            
            stats += `\nWartelisten-Anmeldungen: ${data.waitlist.length}\n`;
            stats += `Einzigartige Käufe: ${data.purchases}\n`;
            
            alert(stats);
        }

        // Prüfen, ob die Ergebnisseite beim Laden angezeigt werden soll
        function checkForCompletedAssessment() {
            const assessmentCompleted = sessionStorage.getItem('assessmentCompleted');
            const storedScore = sessionStorage.getItem('currentScore');
            const storedTraderType = sessionStorage.getItem('currentTraderType');
            
            if (assessmentCompleted === 'true' && storedScore && storedTraderType) {
                // Daten wiederherstellen
                window.currentScore = parseInt(storedScore);
                window.currentTraderType = storedTraderType;
                
                // Ergebnisse direkt anzeigen
                document.getElementById('header').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                
                // Anzeige aktualisieren
                const traderInfo = getTraderType(window.currentScore);
                document.getElementById('scoreDisplay').textContent = `${window.currentScore}/100`;
                document.getElementById('scoreDisplay').style.color = traderInfo.color;
                document.getElementById('traderType').textContent = window.currentTraderType;
                
                // Insights abrufen und anzeigen
                const insights = getInsights(window.currentScore, window.currentTraderType);
                document.getElementById('insights').innerHTML = `
                    <h3>Your Psychology Profile:</h3>
                    <p><strong>Strengths:</strong> ${insights.strengths}</p>
                    <p><strong>Weaknesses:</strong> ${insights.weaknesses}</p>
                    <p><strong>Improvement Focus:</strong> ${insights.improvement}</p>
                    <p><strong>Your Profile:</strong> ${insights.characteristics}</p>
                `;
                
                console.log('✅ Vorherige Assessment-Ergebnisse wiederhergestellt');
            }
        }

        // ===== TASTATURKÜRZEL =====
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey) {
                switch(e.key) {
                    case 'A':
                        e.preventDefault();
                        toggleAdminPanel();
                        break;
                    case 'R':
                        e.preventDefault();
                        if (confirm('Assessment neu starten?')) {
                            location.reload();
                        }
                        break;
                    case 'C':
                        e.preventDefault();
                        clearAllData();
                        break;
                    case 'E':
                        e.preventDefault();
                        exportData();
                        break;
                    case 'D':
                        e.preventDefault();
                        debugInfo();
                        break;
                    case 'S':
                        e.preventDefault();
                        showDetailedStats();
                        break;
                }
            }
        });

        // ===== INITIALISIERUNG BEIM LADEN =====
        window.addEventListener('load', function() {
            console.log('🚀 Trading Psychology Assessment v' + CONFIG.version);
            // console.log('💳 PayPal Integration: Bereit'); // Entfernt, da SDK nicht mehr direkt geladen wird
            console.log('📧 MailerLite Integration: Bereit (Formular + API)');
            console.log('💾 Speichermodus: ' + storageMode);
            console.log('📊 Drücken Sie Strg+Umschalt+A, um das Admin-Panel zu öffnen');
            console.log('📋 Tastaturkürzel:');
            console.log('   Strg+Umschalt+A: Admin-Panel');
            console.log('   Strg+Umschalt+R: Assessment neu starten');
            console.log('   Strg+Umschalt+E: Daten exportieren');
            console.log('   Strg+Umschalt+D: Debug-Info anzeigen');
            console.log('   Strg+Umschalt+S: Detaillierte Statistiken');
            
            // Assessment-Daten aus sessionStorage wiederherstellen, falls verfügbar
            try {
                const storedScore = sessionStorage.getItem('currentScore');
                const storedTraderType = sessionStorage.getItem('currentTraderType');
                const assessmentCompleted = sessionStorage.getItem('assessmentCompleted');
                
                if (assessmentCompleted === 'true' && storedScore && storedTraderType) {
                    window.currentScore = parseInt(storedScore);
                    window.currentTraderType = storedTraderType;
                    console.log('✅ Assessment-Daten aus Session wiederhergestellt:', {
                        score: window.currentScore,
                        type: window.currentTraderType
                    });
                }
            } catch (e) {
                console.log('Konnte nicht aus sessionStorage wiederherstellen:', e);
            }
            
            // Migration ausführen, falls verfügbar
            if (typeof migrateOldData === 'function') {
                migrateOldData();
            }
            
            updateAdminPanel();
            
            // Prüfen, ob Admin-Parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                toggleAdminPanel();
                // Parameter aus URL entfernen
                try {
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.log('Kann den URL-Verlauf in einer Sandbox-Umgebung nicht ändern');
                }
            }
            
            // Die initializePayPal() Aufrufe wurden entfernt, da das SDK nicht mehr direkt geladen wird.
            // Die manuelle PayPal-Option wird direkt angezeigt, wenn nötig.
            
            // Seitenaufruf nur verfolgen, wenn Analytics geladen ist
            if (typeof gtag !== 'undefined') {
                try {
                    trackEvent('page_view', {
                        referrer: document.referrer || 'none',
                        url: window.location.href || 'unknown'
                    });
                } catch (e) {
                    console.log('Tracking-Fehler:', e);
                }
            }
            
            // MailerLite-Formular initialisieren (für API-Key behalten)
            fetch("https://assets.mailerlite.com/jsonp/1568323/forms/158237970273404824/takel").catch(e => console.log('MailerLite-Formular-Laden übersprungen'));
            
            // Prüfen, ob der Benutzer das Assessment zuvor abgeschlossen hat
            checkForCompletedAssessment();
        });

        // ===== FEHLERBEHANDLUNG =====
        window.addEventListener('error', function(e) {
            console.error('Globaler Fehler:', e);
            try {
                trackEvent('javascript_error', {
                    message: e.message || 'Unbekannter Fehler',
                    source: e.filename || 'Unbekannt',
                    line: e.lineno || 0,
                    column: e.colno || 0
                });
            } catch (trackError) {
                console.error('Fehler beim Tracking fehlgeschlagen:', trackError);
            }
        });

        // ===== PERFORMANCE-ÜBERWACHUNG =====
        window.addEventListener('beforeunload', function() {
            try {
                if (startTime && currentQuestion > 0) {
                    const timeSpent = (Date.now() - startTime) / 1000;
                    trackEvent('assessment_abandoned', {
                        question: currentQuestion,
                        timeSpent: timeSpent
                    });
                }
            } catch (e) {
                    console.log('Leistungs-Tracking-Fehler:', e);
                }
            });
        </script>
</body>
</html>
