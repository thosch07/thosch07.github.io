<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Psychology Assessment - Discover Your Trading Personality</title>
    <meta name="description" content="Free AI-powered trading psychology assessment. Discover your trader personality type and emotional patterns in 2 minutes.">

    <!-- Google Tag Manager (GTM) Head Code -->
    <!-- This GTM snippet MUST be the first thing in the <head> -->
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MB4F4HC8');
    </script>
    <!-- End Google Tag Manager -->

    <!-- Google Analytics (GA4) and Google Ads (Consent Mode v2) Integration -->
    <!-- gtag.js must be loaded BEFORE other Google Ads/Analytics scripts -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17370771744"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        // Set default consent status to 'denied' (DSGVO compliant)
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'analytics_storage': 'denied'
        });

        // Google Ads Configuration (will be activated only when Consent = granted)
        gtag('config', 'AW-17370771744'); 

        // Function to grant advertising consent, called by the Cookie Banner
        function grantAdConsent() {
            gtag('consent', 'update', {
                'ad_storage': 'granted',
                'ad_user_data': 'granted',
                'ad_personalization': 'granted'
            });
        }
    </script>

    <style>
        /* General Styles for Body and Container */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
            min-height: 100vh;
            word-wrap: break-word; /* Added for global word breaking */
            overflow-wrap: break-word; /* Added for global word breaking */
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header section */
        .header {
            text-align: center;
            padding: 60px 20px 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .subtitle {
            font-size: 1.3em;
            color: #a0a0a0;
            margin-bottom: 30px;
        }

        .start-button, .next-button, .purchase-button {
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            color: #000;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .start-button:hover, .next-button:hover, .purchase-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.4);
        }

        .disclaimer-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9em;
            color: #a0a0a0;
            text-align: center;
        }

        .disclaimer-box a {
            color: #00d4ff;
            text-decoration: none;
        }

        /* Assessment container */
        .assessment-container {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .question {
            margin-bottom: 30px;
            display: none;
        }

        .question.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question h2 {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #1a1a1a;
        }

        .question h3 {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #333;
        }

        .options {
            display: grid;
            gap: 15px;
        }

        .option {
            padding: 20px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .option:hover {
            border-color: #00d4ff;
            background: #f0f8ff;
            transform: translateX(5px);
        }

        .option.selected {
            background: linear-gradient(135deg, #00ff8810 0%, #00d4ff10 100%);
            border-color: #00d4ff;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        /* Results section */
        .results {
            display: none;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .score-display {
            font-size: 4em;
            font-weight: 800;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        .trader-type {
            font-size: 2em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        .insights {
            text-align: left;
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            line-height: 1.8;
        }

        .insights h3 {
            color: #1a1a1a;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .insights p {
            margin-bottom: 15px;
        }

        .compliance-notice {
            background: #f0f8ff;
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.85em;
            color: #333;
        }

        .compliance-notice strong {
            color: #0066cc;
        }

        .purchase-section {
            margin: 40px 0;
        }

        .purchase-section h3 {
            font-size: 1.6em;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .purchase-section ul {
            list-style: none;
            padding: 0;
        }

        .purchase-section li {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .purchase-section li:before {
            content: "✓ ";
            color: #00ff88;
            font-weight: bold;
            margin-right: 10px;
        }

        .price-display {
            font-size: 1.5em;
            margin: 15px 0;
        }

        .price {
            color: #00ff88;
            font-weight: 800;
            font-size: 1.4em;
        }

        .email-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        #paypal-button-container {
            margin: 20px 0;
            min-height: 50px;
        }

        .waitlist-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .waitlist-section h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #1a1a1a;
        }

        .admin-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1a1f2e;
            color: #fff;
            padding: 30px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .admin-panel.open {
            right: 0;
        }

        .admin-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
        }

        .admin-stats {
            margin: 20px 0;
        }

        .stat-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            color: #a0a0a0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #00ff88;
        }

        .admin-button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
        }

        .admin-button:hover {
            background: #00d4ff;
        }

        .manual-paypal-button {
            background: #ffc439;
            color: #000;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(255, 196, 57, 0.3);
        }

        .manual-paypal-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 196, 57, 0.4);
        }

        .success-message {
            background: #00ff88;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }

        .error-message {
            background: #ef4444;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }

        .assessment-required-notice {
            background: #fbbf24;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .subtitle { font-size: 1.1em; }
            .question h2 { font-size: 1.4em; }
            .question h3 { font-size: 1.2em; }
            .admin-panel { width: 100%; }
            .container { padding: 10px; }
            .header { padding: 40px 20px 30px; }
            .assessment-container, .results { padding: 20px; }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MB4F4HC8"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <div class="header" id="header">
            <h1>AI Trading Psychology Assessment</h1>
            <p class="subtitle">Discover your trader personality type and unlock your potential</p>
            <button class="start-button" onclick="startAssessment()">Start Free Assessment</button>
            <p style="color: #a0a0a0; margin-top: 20px;">Takes only 2 minutes • No email required • 100% Free</p>
                        <!-- Compliance Disclaimer -->
            <div class="disclaimer-box">
                <strong>Educational Purpose Only:</strong> This assessment provides psychological insights for educational purposes. 
                Not financial advice. Trading involves risk. 
                <a href="#" onclick="alert('This tool analyzes psychological patterns in trading behavior for educational purposes only. It does not provide financial advice, trading recommendations, or guarantee trading success. Always consult qualified financial advisors for investment decisions.')">Learn more</a>
            </div>
        </div>

        <div class="assessment-container" id="assessmentContainer">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div id="questionContainer"></div>
            <button class="next-button" onclick="nextQuestion()" style="display: none;">Next Question</button>
        </div>

        <div class="results" id="results">
            <h2>Your Trading Psychology Analysis</h2>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="trader-type" id="traderType"></div>
            <div class="insights" id="insights"></div>
                        <!-- Conversion Tracking for assessment_complete -->
            <script>
              window.dataLayer = window.dataLayer || [];
              window.dataLayer.push({
                event: 'assessment_complete'
              });
            </script>
                        <!-- Compliance Notice in Results -->
            <div class="compliance-notice">
                <strong>Important Notice:</strong> This psychological assessment is for educational and self-improvement purposes only. 
                Results should not be interpreted as financial advice or trading recommendations. 
                Past performance does not guarantee future results. Trading carries substantial risk of loss.
            </div>

            <div class="purchase-section">
                <h3>Get Your Complete 10-Page Psychology Analysis</h3>
                <p>Unlock deeper insights with your personalized report:</p>
                <ul style="text-align: left; margin: 20px auto; max-width: 500px;">
                    <li>Detailed personality breakdown with specific examples</li>
                    <li>Custom 90-day improvement plan tailored to your score</li>
                    <li>Risk management strategies designed for your personality type</li>
                    <li>Pattern recognition exercises to identify emotional triggers</li>
                    <li>Professional psychology toolkit with daily practices</li>
                    <li>Bonus: Access to future updates and tools</li>
                </ul>
                                <div class="price-display">
                    <span class="price">NOW: $47</span>
                </div>

                <!-- Custom Email Form -->
                <div id="email-capture-form" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; margin: 20px auto; position: relative; z-index: 10;">
                    <h4 style="color: #00ff88; font-size: 24px; margin-bottom: 15px;">Get Your Free Analysis</h4>
                    <p style="color: #a0a0a0; font-size: 16px; margin-bottom: 20px;">Enter your email to receive your personalized results</p>
                                        <form id="emailForm" onsubmit="handleEmailSubmit(event); return false;">
                        <input type="email"
                                id="userEmail"
                                name="email"
                               placeholder="Enter your email to receive your report"
                                required
                               autocomplete="email"
                               style="width: 100%; padding: 15px; font-size: 16px; background: rgba(255, 255, 255, 0.9); border: 2px solid #00d4ff; color: #000; border-radius: 10px; margin-bottom: 20px; outline: none; box-sizing: border-box;">
                                                <button type="submit"
                                 style="background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #000; font-weight: 700; padding: 15px 30px; font-size: 16px; border-radius: 50px; border: none; cursor: pointer; transition: all 0.3s ease; width: 100%; box-sizing: border-box;">
                            Get Your Personalized Report
                        </button>
                    </form>
                                        <div id="email-success" style="display: none; margin-top: 20px;">
                        <h4 style="color: #00ff88; font-size: 24px; margin-bottom: 15px;">Thank you!</h4>
                        <p style="color: #fff; font-size: 16px;">Your email has been saved. Complete your purchase below to receive your report.</p>
                    </div>
                </div>
                                <!-- Assessment Required Notice -->
                <div id="assessment-required-notice" style="display: none;">
                    <div class="assessment-required-notice">
                        <p>⚠️ Please complete the assessment first to get your personalized report!</p>
                        <button class="start-button" onclick="location.reload()">Start Assessment Now</button>
                    </div>
                </div>
                                <div id="paypal-button-container" style="display: none;"></div>

                                <!-- Manual PayPal Fallback -->
                <div id="manual-paypal" style="display: none;">
                    <p style="color: #666; margin: 20px 0;">Or use PayPal directly:</p>
                    <button class="manual-paypal-button" onclick="manualPayPal()">
                        Pay with PayPal ($47)
                    </button>
                </div>
            </div>

            <div class="waitlist-section">
                <h3>Join the Waitlist for AI Trading Tools</h3>
                <p>Be first to access our upcoming AI-powered trading psychology tools:</p>
                <ul style="text-align: left; margin: 15px 0;">
                    <li>AI Psychology Tracker - Daily mood vs performance analysis</li>
                    <li>Real-time Emotion Monitor - Alerts before emotional trades</li>
                    <li>Advanced Risk Calculator - Based on your psychology profile</li>
                </ul>
                <form id="waitlistForm">
                    <input type="email"
                            id="waitlistEmail"
                            class="email-input"
                            placeholder="Enter your email for early access"
                            required>
                    <button type="submit" class="purchase-button">Join Waitlist</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Legal Footer -->
    <footer style="background: #0f1419; padding: 20px; text-align: center; border-top: 1px solid #333; margin-top: 40px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <p style="color: #8899a6; font-size: 14px; margin-bottom: 15px;">
                Educational Platform by Schnitzlein Consulting
            </p>
            <p style="color: #8899a6; font-size: 14px;">
                <a href="https://schnitzleinconsulting.com/impressum" target="_blank" style="color: #00ff88; text-decoration: none; margin: 0 10px;">Impressum</a>
                |
                <a href="https://schnitzleinconsulting.com/datenschutz" target="_blank" style="color: #00ff88; text-decoration: none; margin: 0 10px;">Datenschutz</a>
                |
                <a href="https://www.schnitzleinconsulting.com/en/datenschutz" target="_blank" style="color: #00ff88; text-decoration: none; margin: 0 10px;">Privacy Policy</a>
            </p>
            <p style="color: #666; font-size: 12px; margin-top: 15px;">
                © 2025 Schnitzlein Consulting - All Rights Reserved
            </p>
        </div>
    </footer>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <button class="admin-close" onclick="toggleAdminPanel()">&times;</button>
        <h2>Admin Dashboard</h2>
        <div class="admin-stats">
            <div class="stat-item">
                <div class="stat-label">Total Assessments</div>
                <div class="stat-value" id="totalAssessments">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Revenue</div>
                <div class="stat-value" id="totalRevenue">$0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Conversion Rate</div>
                <div class="stat-value" id="conversionRate">0%</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Waitlist Signups</div>
                <div class="stat-value" id="waitlistCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Average Score</div>
                <div class="stat-value" id="avgScore">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Storage Mode</div>
                <div class="stat-value" id="storageMode">checking...</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Score Distribution</div>
                <div id="scoreDistribution" style="font-size: 0.9em; margin-top: 10px;"></div>
            </div>
        </div>
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Actions</h3>
        <button class="admin-button" onclick="exportData()">Export All Data (CSV)</button>
        <button class="admin-button" onclick="testPurchase()">Test Purchase (Admin Only)</button>
        <button class="admin-button" onclick="clearAllData()">Clear All Data</button>
        <button class="admin-button" onclick="debugInfo()">Show Debug Info</button>
        <button class="admin-button" onclick="showDetailedStats()">Detailed Statistics</button>
    </div>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ===== KONFIGURATION =====
        const CONFIG = {
            regularPrice: 47,
            paypalEmail: 'th.schnitzlein@gmail.com',
            adminPassword: 'trading123', // PLEASE CHANGE THIS PASSWORD IN A PRODUCTION ENVIRONMENT!
            version: '4.4.0',
            analyticsEnabled: true
        };

        // ===== MAILERLITE INTEGRATION =====
        const MAILERLITE_CONFIG = {
            apiKey: 'YOUR_MAILERLITE_API_KEY', // REPLACE THIS WITH YOUR ACTUAL API KEY
            apiUrl: 'https://connect.mailerlite.com/api',
            groups: {
                vulnerable: '156165398716220484', // 0-39: Risk Seeker
                developing: '156165389906085155', // 40-59: Emotional Challenger
                solid: '156165381737678326',      // 60-79: Evolving Trader
                champion: '156165398716220484'    // 80-100: Disciplined Strategist
            }
        };

        // Fixed Function to handle MailerLite form submission
        function handleMailerLiteSubmit() {
            const email = document.getElementById('mailerliteEmailInput').value;
                        // Get score and trader type from session storage as backup
            const storedScore = sessionStorage.getItem('currentScore');
            const storedTraderType = sessionStorage.getItem('currentTraderType');

            // Use stored values if window values are missing
            if (!window.currentScore && storedScore) {
                window.currentScore = parseInt(storedScore);
            }
            if (!window.currentTraderType && storedTraderType) {
                window.currentTraderType = storedTraderType;
            }

            // Check if assessment has been completed
            if (!window.currentScore || !window.currentTraderType) {
                // Hide the form and show the notice
                document.getElementById('mlb2-27668853').style.display = 'none';
                document.getElementById('assessment-required-notice').style.display = 'block';
                                // Track this event
                trackEvent('form_submit_without_assessment');

                return false; // Prevent form submission
            }

            if (email) {
                // Save email for later processing
                window.currentEmail = email;
                // The form will submit normally to MailerLite
                // After submission, we'll show PayPal options
                setTimeout(() => {
                    showPayPalOptions();
                }, 2000);
            }
            return true; // Allow form submission
        }

        function showPayPalOptions() {
            // Displays only the manual PayPal button
            document.getElementById('manual-paypal').style.display = 'block';
            // Removes the paypal-button-container as we no longer use the SDK directly
            document.getElementById('paypal-button-container').style.display = 'none';         }

        // Handles email form submission
        function handleEmailSubmit(event) {
            event.preventDefault();

            const email = document.getElementById('userEmail').value;

            // Check if assessment has been completed
            if (!window.currentScore || !window.currentTraderType) {
                // Try to restore from sessionStorage
                const storedScore = sessionStorage.getItem('currentScore');
                const storedTraderType = sessionStorage.getItem('currentTraderType');

                if (storedScore && storedTraderType) {
                    window.currentScore = parseInt(storedScore);
                    window.currentTraderType = storedTraderType;
                } else {
                    // Hide the form and show the notice
                    document.getElementById('email-capture-form').style.display = 'none';
                    document.getElementById('assessment-required-notice').style.display = 'block';
                    trackEvent('email_submit_without_assessment');
                    return false;
                }
            }

            if (email && validateEmail(email)) {
                // Save email
                window.currentEmail = email;
                sessionStorage.setItem('currentEmail', email);

                // Hide form, show success
                document.getElementById('emailForm').style.display = 'none';
                document.getElementById('email-success').style.display = 'block';

                // Add to MailerLite via API in background
                addToMailerLiteAPI(email, window.currentScore, window.currentTraderType); // window.currentScore is passed here

                // Show PayPal options
                showPayPalOptions();

                trackEvent('email_captured', { score: window.currentScore });
            }

            return false;
        }

        // Function to add subscriber to MailerLite API
        async function addToMailerLiteAPI(email, score, traderType) { // 'score' is the value of window.currentScore here
            console.log('Adding to MailerLite via API:', email, score, traderType);

            // Determine which group based on score
            let groupId;
            if (score < 40) {
                groupId = MAILERLITE_CONFIG.groups.vulnerable;
            } else if (score < 60) {
                groupId = MAILERLITE_CONFIG.groups.developing;
            } else if (score < 80) {
                groupId = MAILERLITE_CONFIG.groups.solid;
            } else {
                groupId = MAILERLITE_CONFIG.groups.champion;
            }

            try {
                const response = await fetch(`${MAILERLITE_CONFIG.apiUrl}/subscribers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${MAILERLITE_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        email: email,
                        groups: [groupId],
                        fields: {
                            ai_final_score: score, // 'score' renamed to 'ai_final_score' here
                            trader_type: traderType,
                            assessment_date: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    console.log('✅ Successfully added to MailerLite group via API');
                    trackEvent('mailerlite_api_success', { score, traderType });
                } else {
                    const error = await response.text();
                    console.error('MailerLite API error:', response.status, error);
                    trackEvent('mailerlite_api_error', { status: response.status });
                }
            } catch (error) {
                console.error('MailerLite API integration error:', error);
                trackEvent('mailerlite_api_exception', { error: error.message });
            }
        }

        // MailerLite form success callback - not used anymore but kept for compatibility
        function ml_webform_success_27668853() {
            console.log('MailerLite form success callback (deprecated)');
        }

        // ===== ANALYTICS TRACKING (GT_TAG) =====
        function trackEvent(eventName, parameters = {}) {
            if (CONFIG.analyticsEnabled && typeof gtag !== 'undefined') {
                gtag('event', eventName, parameters);
            }
            console.log('Event tracked:', eventName, parameters);
        }

        // ===== ASSESSMENT QUESTIONS (DUMMY DATA) =====
        const questions = [
            {
                question: "After a losing trade, your first instinct is to:",
                options: [
                    { text: "Immediately enter another trade to recover losses", value: 10 },
                    { text: "Take a break and analyze what went wrong", value: 30 },
                    { text: "Stick to your plan and wait for the next setup", value: 40 },
                    { text: "Review your rules and only trade if criteria are met", value: 50 }
                ]
            },
            {
                question: "When you see others making profits on a trade you missed, you feel:",
                options: [
                    { text: "Strong regret and a urge to jump into the next hot tip", value: 10 },
                    { text: "Slight frustration, but you stick to your own strategy", value: 30 },
                    { text: "Curiosity to learn, but no desire to chase the trade", value: 40 },
                    { text: "Indifferent, focusing only on your own disciplined process", value: 50 }
                ]
            },
            {
                question: "How do you react to unexpected market volatility?",
                options: [
                    { text: "Panic and close positions or over-trade to react", value: 10 },
                    { text: "Feel nervous, but try to find opportunities within your plan", value: 30 },
                    { text: "Remain calm and observe, waiting for clarity", value: 40 },
                    { text: "See it as a normal market event and stick to your predefined risk management", value: 50 }
                ]
            },
            {
                question: "When your trading strategy has a drawdown phase, you:",
                options: [
                    { text: "Abandon it quickly and search for a new 'holy grail' strategy", value: 10 },
                    { text: "Feel anxious and consider making changes, even if your rules say otherwise", value: 30 },
                    { text: "Review your strategy to ensure it's still valid, but stick with it if it is", value: 40 },
                    { text: "Trust your backtesting and continue executing your strategy without emotional interference", value: 50 }
                ]
            },
            {
                question: "Before placing a trade, you typically:",
                options: [
                    { text: "Act on a gut feeling or a quick tip from social media", value: 10 },
                    { text: "Have a basic idea, but sometimes deviate if an opportunity arises quickly", value: 30 },
                    { text: "Conduct a thorough analysis, but might occasionally second-guess yourself", value: 40 },
                    { text: "Follow a strict checklist of criteria, entering only when all conditions are met", value: 50 }
                ]
            },
            {
                question: "How do you handle a significant winning streak?",
                options: [
                    { text: "Increase position sizes aggressively, feeling invincible", value: 10 },
                    { text: "Feel confident, but occasionally take on slightly more risk than usual", value: 30 },
                    { text: "Appreciate the success, but remain cautious and stick to your risk management", value: 40 },
                    { text: "Maintain discipline and continue executing your strategy as planned, understanding streaks are temporary", value: 50 }
                ]
            },
            {
                question: "Your approach to setting stop-loss orders is:",
                options: [
                    { text: "Rarely use them, hoping the market will turn around", value: 10 },
                    { text: "Set them, but sometimes move them further away if the price is close", value: 30 },
                    { text: "Set them according to your plan, but it's hard to accept a loss when hit", value: 40 },
                    { text: "Strictly adhere to predefined stop-loss levels, accepting them as part of the trading cost", value: 50 }
                ]
            },
            {
                question: "When confronted with conflicting news or analysis, you:",
                options: [
                    { text: "Become confused and indecisive, leading to missed opportunities or bad trades", value: 10 },
                    { text: "Feel a bit overwhelmed, but try to find a consensus or dominant view", value: 30 },
                    { text: "Refer back to your own analysis and strategy to form your judgment", value: 40 },
                    { text: "Filter out the noise and rely solely on your established trading system and rules", value: 50 }
                ]
            },
            {
                question: "How often do you review your past trades (both winners and losers)?",
                options: [
                    { text: "Almost never, I prefer to focus on the next trade", value: 10 },
                    { text: "Occasionally, mainly looking at big wins or losses", value: 30 },
                    { text: "Regularly, trying to identify patterns and areas for improvement", value: 40 },
                    { text: "Diligently, maintaining a trading journal and analyzing every trade for lessons and statistical insights", value: 50 }
                ]
            },
            {
                question: "What drives your decision to enter a trade?",
                options: [
                    { text: "Fear of missing out (FOMO) or excitement about quick profits", value: 10 },
                    { text: "A mix of strategy signals and market sentiment", value: 30 },
                    { text: "Primarily your strategy signals, with a minor influence from overall market conditions", value: 40 },
                    { text: "Solely the objective entry criteria defined by your trading system", value: 50 }
                ]
            }
        ];

        let currentQuestionIndex = 0;
        let totalScore = 0;
        let selectedOptionForCurrentQuestion = null; // Track selected option for the current question
        window.currentScore = 0; // Global score for MailerLite
        window.currentTraderType = ''; // Global trader type for MailerLite
        window.currentEmail = ''; // Global email for MailerLite

        // Load data from session storage on page load
        document.addEventListener('DOMContentLoaded', (event) => {
            const storedIndex = sessionStorage.getItem('currentQuestionIndex');
            const storedScore = sessionStorage.getItem('totalScore');
            const storedEmail = sessionStorage.getItem('currentEmail');
            const storedCurrentScore = sessionStorage.getItem('currentScore'); // For the global window.currentScore
            const storedCurrentTraderType = sessionStorage.getItem('currentTraderType'); // For the global window.currentTraderType

            if (storedIndex !== null && storedScore !== null) {
                currentQuestionIndex = parseInt(storedIndex);
                totalScore = parseInt(storedScore);
                
                // Restore global window variables if they exist in session storage
                if (storedCurrentScore) {
                    window.currentScore = parseInt(storedCurrentScore);
                }
                if (storedCurrentTraderType) {
                    window.currentTraderType = storedCurrentTraderType;
                }
                if (storedEmail) {
                    window.currentEmail = storedEmail;
                }

                // If assessment started, show it
                if (currentQuestionIndex > 0 || totalScore > 0) {
                    document.getElementById('header').style.display = 'none';
                    document.getElementById('assessmentContainer').style.display = 'block';
                    showQuestion(); // Show the current question based on loaded index
                    // If results are already calculated, show results
                    if (currentQuestionIndex >= questions.length) {
                         displayResults(); // Re-display results if assessment is complete
                    }
                }
            } else {
                // Initialize default score distribution in local storage if not present
                if (!localStorage.getItem('adminStats')) { // Check for adminStats directly
                    localStorage.setItem('adminStats', JSON.stringify({
                        totalAssessments: 0,
                        totalRevenue: 0,
                        waitlistCount: 0,
                        totalScoreSum: 0,
                        scoreDistribution: { '0-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 }
                    }));
                }
            }

            // Check for admin login
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === CONFIG.adminPassword) {
                toggleAdminPanel();
            }

            // Bind waitlist form submission
            document.getElementById('waitlistForm').addEventListener('submit', handleWaitlistSubmit);
        });

        function startAssessment() {
            document.getElementById('header').style.display = 'none';
            document.getElementById('assessmentContainer').style.display = 'block';
            currentQuestionIndex = 0;
            totalScore = 0;
            selectedOptionForCurrentQuestion = null; // Clear any lingering selection
            sessionStorage.removeItem('selectedOptionForCurrentQuestion'); // Clear any lingering selection
            sessionStorage.setItem('currentQuestionIndex', currentQuestionIndex);
            sessionStorage.setItem('totalScore', totalScore);
            trackEvent('assessment_started');
            showQuestion();
        }

        function showQuestion() {
            const questionContainer = document.getElementById('questionContainer');
            questionContainer.innerHTML = ''; // Clear previous question

            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question active';
                questionDiv.innerHTML = `
                    <h2>Question ${currentQuestionIndex + 1} of ${questions.length}</h2>
                    <h3>${q.question}</h3>
                    <div class="options">
                        ${q.options.map((option, index) => `
                            <div class="option" data-value="${option.value}" onclick="selectOption(${index})">
                                ${option.text}
                            </div>
                        `).join('')}
                    </div>
                `;
                questionContainer.appendChild(questionDiv);

                updateProgressBar();

                // Restore selected option if returning to question
                const storedSelectedOption = sessionStorage.getItem('selectedOptionForCurrentQuestion');
                if (storedSelectedOption !== null) {
                    selectedOptionForCurrentQuestion = parseInt(storedSelectedOption);
                    const options = questionDiv.querySelectorAll('.option');
                    if (options[selectedOptionForCurrentQuestion]) { // Corrected typo here
                        options[selectedOptionForCurrentQuestion].classList.add('selected'); // Corrected typo here
                        // Show next button immediately if an option was already selected
                        // Corrected: Use querySelector and setTimeout for robustness
                        setTimeout(() => {
                            const nextButton = document.querySelector('.next-button');
                            if (nextButton) {
                                nextButton.style.display = 'block';
                            }
                        }, 50);
                    }
                } else {
                    // Hide next button if no option selected for new question
                    // Corrected: Use querySelector and setTimeout for robustness
                    setTimeout(() => {
                        const nextButton = document.querySelector('.next-button');
                        if (nextButton) {
                            nextButton.style.display = 'none';
                        }
                    }, 50);
                }

            } else {
                displayResults();
            }
        }

        function selectOption(optionIndex) {
            const currentQuestionDiv = document.querySelector('.question.active');
            const options = currentQuestionDiv.querySelectorAll('.option');

            // Remove 'selected' class from all options
            options.forEach((option) => {
                option.classList.remove('selected');
            });

            // Add 'selected' class to the clicked option
            options[optionIndex].classList.add('selected');
            selectedOptionForCurrentQuestion = optionIndex;
            sessionStorage.setItem('selectedOptionForCurrentQuestion', optionIndex); // Save selected option

            // Show next button
            // Using setTimeout to ensure the element is rendered and accessible after innerHTML changes
            setTimeout(() => {
                const nextButton = document.querySelector('.next-button'); // Use querySelector as it's a class
                if (nextButton) {
                    nextButton.style.display = 'block';
                } else {
                    console.warn("Element '.next-button' not found. Cannot set 'display'.");
                }
            }, 50); // Small delay
        }

        function nextQuestion() {
            if (selectedOptionForCurrentQuestion === null) {
                alert('Please select an option before proceeding.');
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            const selectedValue = currentQuestion.options[selectedOptionForCurrentQuestion].value;
            totalScore += selectedValue;
            trackEvent('question_answered', { question_index: currentQuestionIndex, score_added: selectedValue });

            currentQuestionIndex++;
            selectedOptionForCurrentQuestion = null; // Reset for next question
            sessionStorage.removeItem('selectedOptionForCurrentQuestion'); // Clear stored selection

            sessionStorage.setItem('currentQuestionIndex', currentQuestionIndex);
            sessionStorage.setItem('totalScore', totalScore);

            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                displayResults();
            }
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progress = (currentQuestionIndex / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function getTraderType(score) {
            if (score >= 0 && score < 40) return "Risk Seeker (Vulnerable)";
            if (score >= 40 && score < 60) return "Emotional Challenger (Developing)";
            if (score >= 60 && score < 80) return "Evolving Trader (Solid)";
            if (score >= 80 && score <= 100) return "Disciplined Strategist (Champion)";
            return "Undefined";
        }

        function getInsights(score) {
            if (score >= 0 && score < 40) {
                return `
                    <h3>Your Trading Psychology: Risk Seeker (Vulnerable)</h3>
                    <p><strong>Overview:</strong> Your assessment suggests a trading style heavily influenced by emotion, impulsivity, and a tendency towards high-risk behavior. You might often chase quick profits, struggle with losses, and deviate from plans.</p>
                    <p><strong>Strengths:</strong> You may have a high tolerance for risk, which *could* be channeled effectively with discipline, and a willingness to act quickly. However, without control, these can be liabilities.</p>
                    <p><strong>Challenges:</strong> This score indicates significant challenges with discipline, emotional control, and adherence to risk management. You likely experience frequent large drawdowns, overtrading, and frustration.</p>
                    <p><strong>Recommendations:</strong> Focus intensely on foundational trading psychology. Develop strict rules for entry, exit, and risk management, and *adhere* to them. Practice emotional regulation, mindfulness, and rigorous trade journaling. Consider starting with very small positions or paper trading until consistent discipline is established.</p>
                `;
            } else if (score >= 40 && score < 60) {
                return `
                    <h3>Your Trading Psychology: Emotional Challenger (Developing)</h3>
                    <p><strong>Overview:</strong> You are likely aware of the importance of trading psychology but still struggle with emotional consistency. You might have a basic plan but find it hard to follow during volatile market conditions or after a series of wins/losses.</p>
                    <p><strong>Strengths:</strong> You have a foundation of understanding and a desire to improve. You're likely capable of analysis but sometimes let emotions override your logic.</p>
                    <p><strong>Challenges:</strong> Inconsistent discipline, occasional impulsive decisions (FOMO, revenge trading), difficulty accepting small losses, and managing greed/fear. You might oscillate between periods of good discipline and emotional setbacks.</p>
                    <p><strong>Recommendations:</strong> Work on strengthening your emotional resilience. Develop a robust trading plan that includes detailed rules for every scenario (entry, exit, risk, position sizing, emotional triggers). Practice self-awareness and pause before making impulsive trades. Focus on process consistency over immediate results.</p>
                `;
            } else if (score >= 60 && score < 80) {
                return `
                    <h3>Your Trading Psychology: Evolving Trader (Solid)</h3>
                    <p><strong>Overview:</strong> You demonstrate a solid understanding and application of trading psychology principles. You are generally disciplined, adhere to your plan, and manage emotions well, but still have areas for refinement.</p>
                    <p><strong>Strengths:</strong> Consistent discipline, good risk management, ability to learn from mistakes, and a generally rational approach to the market. You understand that trading is a marathon, not a sprint.</p>
                    <p><strong>Challenges:</strong> Occasional bouts of overconfidence after wins, slight hesitation during high-conviction setups, or minor emotional reactions to unexpected market events. You're good, but not perfect.</p>
                    <p><strong>Recommendations:</strong> Continue to refine your emotional control and decision-making processes. Focus on identifying your specific psychological "blind spots" (e.g., overconfidence, impatience) and creating targeted strategies to address them. Maintain detailed trade journals to track not just results but also your emotional state during trades. Seek continuous learning and mentorship.</p>
                `;
            } else if (score >= 80 && score <= 100) {
                return `
                    <h3>Your Trading Psychology: Disciplined Strategist (Champion)</h3>
                    <p><strong>Overview:</strong> You exhibit an exceptional level of emotional control, discipline, and systematic thinking in your trading. You consistently execute your plan, manage risk effectively, and are largely immune to common psychological pitfalls.</p>
                    <p><strong>Strengths:</strong> High emotional intelligence, unwavering discipline, robust risk management, systematic approach, resilience to drawdowns, and objective decision-making. You embody the qualities of a professional trader.</p>
                    <p><strong>Challenges:</strong> While highly disciplined, even champions face challenges. Your challenges might be subtle, such as complacency, or adapting to extreme, unprecedented market conditions. The key is continuous self-assessment to maintain your edge.</p>
                    <p><strong>Recommendations:</strong> Continue to iterate and optimize your trading system. Mentor others, as teaching reinforces your own understanding. Explore advanced psychological techniques for peak performance and sustained focus. Your primary goal is to maintain your high level of consistent execution and psychological resilience.</p>
                `;
            }
            return "No insights available for this score range.";
        }

        function displayResults() {
            document.getElementById('assessmentContainer').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            const scoreDisplay = document.getElementById('scoreDisplay');
            const traderTypeDisplay = document.getElementById('traderType');
            const insightsDisplay = document.getElementById('insights');

            const finalScore = Math.round((totalScore / (questions.length * 50)) * 100);
            const traderType = getTraderType(finalScore);
            const insights = getInsights(finalScore);

            scoreDisplay.textContent = `${finalScore}%`;
            traderTypeDisplay.textContent = traderType;
            insightsDisplay.innerHTML = insights;

            window.currentScore = finalScore; // Set global score
            window.currentTraderType = traderType; // Set global trader type

            // Save final score and type to session storage for persistence
            sessionStorage.setItem('currentScore', finalScore);
            sessionStorage.setItem('currentTraderType', traderType);

            trackEvent('assessment_results_displayed', { final_score: finalScore, trader_type: traderType });

            updateAdminPanelStats(finalScore, traderType);
        }

        // ===== ADMIN PANEL FUNCTIONS =====
        let adminPanelOpen = false;

        function toggleAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            adminPanelOpen = !adminPanelOpen;
            adminPanel.classList.toggle('open', adminPanelOpen);
            if (adminPanelOpen) {
                loadAdminStats();
            }
        }

        function loadAdminStats() {
            const stats = JSON.parse(localStorage.getItem('adminStats')) || {
                totalAssessments: 0,
                totalRevenue: 0,
                waitlistCount: 0,
                totalScoreSum: 0, // Sum of all scores to calculate average
                scoreDistribution: { '0-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 }
            };

            document.getElementById('totalAssessments').textContent = stats.totalAssessments;
            document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue.toFixed(2)}`;
            document.getElementById('waitlistCount').textContent = stats.waitlistCount;
            document.getElementById('avgScore').textContent = stats.totalAssessments > 0 ? (stats.totalScoreSum / stats.totalAssessments).toFixed(1) : '0';
            document.getElementById('storageMode').textContent = typeof localStorage !== 'undefined' ? 'LocalStorage Enabled' : 'LocalStorage Disabled';

            const scoreDistDiv = document.getElementById('scoreDistribution');
            scoreDistDiv.innerHTML = '';
            for (const range in stats.scoreDistribution) {
                scoreDistDiv.innerHTML += `<div>${range}: ${stats.scoreDistribution[range]}</div>`;
            }
        }

        function updateAdminPanelStats(score, traderType) {
            let stats = JSON.parse(localStorage.getItem('adminStats')) || {
                totalAssessments: 0,
                totalRevenue: 0,
                waitlistCount: 0,
                totalScoreSum: 0,
                scoreDistribution: { '0-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 }
            };

            stats.totalAssessments += 1;
            stats.totalScoreSum += score;

            // Update score distribution
            if (score < 40) stats.scoreDistribution['0-39']++;
            else if (score < 60) stats.scoreDistribution['40-59']++;
            else if (score < 80) stats.scoreDistribution['60-79']++;
            else stats.scoreDistribution['80-100']++;

            localStorage.setItem('adminStats', JSON.stringify(stats));
            if (adminPanelOpen) {
                loadAdminStats();
            }
        }

        function testPurchase() {
            if (confirm('This will simulate a purchase for $47. Continue?')) {
                updateRevenue(CONFIG.regularPrice);
                alert('Test purchase recorded!');
                trackEvent('test_purchase_recorded');
            }
        }

        function updateRevenue(amount) {
            let stats = JSON.parse(localStorage.getItem('adminStats')) || {
                totalAssessments: 0,
                totalRevenue: 0,
                waitlistCount: 0,
                totalScoreSum: 0,
                scoreDistribution: { '0-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 }
            };
            stats.totalRevenue += amount;
            localStorage.setItem('adminStats', JSON.stringify(stats));
            if (adminPanelOpen) {
                loadAdminStats();
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data (assessments, revenue, waitlist)? This cannot be undone.')) {
                localStorage.removeItem('adminStats');
                sessionStorage.clear(); // Clear session data as well
                alert('All data cleared!');
                trackEvent('all_data_cleared');
                loadAdminStats(); // Reload stats to show zeros
            }
        }

        function debugInfo() {
            let debug = {
                localStorageData: localStorage.getItem('adminStats'),
                sessionStorageData: {
                    currentQuestionIndex: sessionStorage.getItem('currentQuestionIndex'),
                    totalScore: sessionStorage.getItem('totalScore'),
                    selectedOptionForCurrentQuestion: sessionStorage.getItem('selectedOptionForCurrentQuestion'),
                    currentScore: sessionStorage.getItem('currentScore'),
                    currentTraderType: sessionStorage.getItem('currentTraderType'),
                    currentEmail: sessionStorage.getItem('currentEmail')
                },
                globalVars: {
                    currentQuestionIndex: currentQuestionIndex,
                    totalScore: totalScore,
                    selectedOptionForCurrentQuestion: selectedOptionForCurrentQuestion,
                    windowCurrentScore: window.currentScore,
                    windowCurrentTraderType: window.currentTraderType,
                    windowCurrentEmail: window.currentEmail
                },
                config: CONFIG,
                mailerliteConfig: MAILERLITE_CONFIG,
                browserInfo: {
                    userAgent: navigator.userAgent,
                    language: navigator.language
                }
            };
            console.log("Debug Info:", debug);
            alert("Debug info logged to console. Open developer tools (F12) to view.");
            trackEvent('debug_info_accessed');
        }

        function showDetailedStats() {
            const stats = JSON.parse(localStorage.getItem('adminStats')) || {
                totalAssessments: 0,
                totalRevenue: 0,
                waitlistCount: 0,
                totalScoreSum: 0,
                scoreDistribution: { '0-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 }
            };

            let detailedMessage = `
                Detailed Statistics:
                Total Assessments: ${stats.totalAssessments}
                Total Revenue: $${stats.totalRevenue.toFixed(2)}
                Waitlist Signups: ${stats.waitlistCount}
                Average Score: ${stats.totalAssessments > 0 ? (stats.totalScoreSum / stats.totalAssessments).toFixed(1) : '0'}

                Score Distribution:
            `;
            for (const range in stats.scoreDistribution) {
                detailedMessage += `    ${range}: ${stats.scoreDistribution[range]} (${(stats.scoreDistribution[range] / stats.totalAssessments * 100 || 0).toFixed(1)}%)\n`;
            }

            alert(detailedMessage);
            trackEvent('detailed_stats_viewed');
        }


        // ===== Waitlist Submission (using Fetch API for MailerLite) =====
        async function handleWaitlistSubmit(event) {
            event.preventDefault(); // Prevent default form submission
            const emailInput = document.getElementById('waitlistEmail');
            const email = emailInput.value;

            if (!validateEmail(email)) {
                alert('Please enter a valid email address.');
                return;
            }

            // Optional: Save email to session/local storage if needed for other purposes
            // sessionStorage.setItem('waitlistEmail', email);

            // Update admin panel waitlist count immediately
            let stats = JSON.parse(localStorage.getItem('adminStats')) || {
                totalAssessments: 0,
                totalRevenue: 0,
                waitlistCount: 0,
                totalScoreSum: 0,
                scoreDistribution: { '0-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 }
            };
            stats.waitlistCount += 1;
            localStorage.setItem('adminStats', JSON.stringify(stats));
            if (adminPanelOpen) {
                loadAdminStats();
            }

            // Add to MailerLite via API (assuming a specific group for waitlist)
            const waitlistGroupId = 'YOUR_MAILERLITE_WAITLIST_GROUP_ID'; // REPLACE THIS WITH YOUR ACTUAL WAITLIST GROUP ID
            if (MAILERLITE_CONFIG.apiKey && MAILERLITE_CONFIG.apiUrl && waitlistGroupId !== 'YOUR_MAILERLITE_WAITLIST_GROUP_ID') {
                try {
                    const response = await fetch(`${MAILERLITE_CONFIG.apiUrl}/subscribers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${MAILERLITE_CONFIG.apiKey}`
                        },
                        body: JSON.stringify({
                            email: email,
                            groups: [waitlistGroupId],
                            status: 'active' // Set status to active
                        })
                    });

                    if (response.ok) {
                        alert('Thank you for joining the waitlist! You will receive updates.');
                        trackEvent('waitlist_signup_success');
                        emailInput.value = ''; // Clear email field
                    } else {
                        const errorData = await response.json(); // Get more detailed error from JSON
                        console.error('MailerLite API waitlist error:', response.status, errorData);
                        alert('There was an error joining the waitlist. Please try again or contact support.');
                        trackEvent('waitlist_signup_error', { status: response.status, message: errorData.message || 'unknown' });
                    }
                } catch (error) {
                    console.error('MailerLite API waitlist integration error:', error);
                    alert('There was a technical issue. Please try again later.');
                    trackEvent('waitlist_signup_exception', { error: error.message });
                }
            } else {
                alert('Thank you for joining the waitlist! (MailerLite API not configured or waitlist group ID missing)');
                trackEvent('waitlist_signup_success_no_api');
                emailInput.value = ''; // Clear email field
            }
        }

        function validateEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }


        // ===== PayPal Integration (manual fallback only) =====
        function manualPayPal() {
            const email = window.currentEmail; // Use the email captured earlier

            if (!email) {
                // If email wasn't captured for some reason, try from session storage
                const storedEmail = sessionStorage.getItem('currentEmail');
                if (storedEmail) {
                    window.currentEmail = storedEmail;
                } else {
                    alert("Please enter your email address above before proceeding to purchase.");
                    // Ensure the email capture form is visible
                    document.getElementById('email-capture-form').style.display = 'block';
                    document.getElementById('assessment-required-notice').style.display = 'none';
                    return;
                }
            }

            if (window.currentScore === 0 && !sessionStorage.getItem('currentScore')) {
                alert("Please complete the assessment first to get your personalized report before purchasing.");
                document.getElementById('results').style.display = 'none'; // Hide results
                document.getElementById('header').style.display = 'block'; // Show start screen
                return;
            }

            // Prepare custom fields for PayPal
            const customFields = {
                email: email,
                score: window.currentScore,
                trader_type: window.currentTraderType,
                assessment_version: CONFIG.version
            };

            // Construct PayPal URL for a fixed price product
            const paypalUrl = `https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=${encodeURIComponent(CONFIG.paypalEmail)}&item_name=${encodeURIComponent('AI Trading Psychology Analysis Report')}&amount=${CONFIG.regularPrice}&currency_code=USD&custom=${encodeURIComponent(JSON.stringify(customFields))}&no_shipping=1&no_note=1&return=YOUR_SUCCESS_URL&cancel_return=YOUR_CANCEL_URL`;
            
            // IMPORTANT: Replace YOUR_SUCCESS_URL and YOUR_CANCEL_URL with actual URLs on your site.
            // Example:
            // const paypalUrl = `https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=${encodeURIComponent(CONFIG.paypalEmail)}&item_name=${encodeURIComponent('AI Trading Psychology Analysis Report')}&amount=${CONFIG.regularPrice}&currency_code=USD&custom=${encodeURIComponent(JSON.stringify(customFields))}&no_shipping=1&no_note=1&return=${encodeURIComponent('https://thosch07.github.io/thank-you.html')}&cancel_return=${encodeURIComponent('https://thosch07.github.io/assessment.html')}`;

            window.open(paypalUrl, '_blank');
            trackEvent('manual_paypal_clicked', { email: email, score: window.currentScore });
        }
    </script>
</body>
</html>
